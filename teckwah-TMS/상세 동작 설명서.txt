# 프로젝트 통합 상세 동작 설명서

## 개요
이 문서는 프로젝트 전반에 대한 **기능 명세**와 **동작 규칙**을 통합하여 정리한 문서입니다.  
모든 페이지는 **행 단위 락(Row-Level Lock)**, **권한(ADMIN/USER)**, **상태 변경 규칙** 등을 따르며, **초기 로드값**(페이지 진입 시 미리 데이터 로드)이 존재합니다.
모든 api들 전달 값은 pydantic의 자동 alias 변환을 고려하여 신중히 작성 구현 합니다
모든 서버 로직들은 정확한 레이어를 구분하여 router<->schema<->service<->model<->db(repository)의 단계적 절차를 따릅니다
백엔드 아키텍처에서의 레이어드 아키텍처(Layered Architecture) 구조를 엄격히 따르고 있다는 것을 말하고 있습니다. 다시 말해, 서버 로직을 구현할 때 각 책임(responsibility)을 명확히 분리하여, 각 계층(layer)마다 역할을 구분하고 해당 계층 간의 인터페이스만 통해서만 상호작용한다는 원칙

---

## 1. 권한 구조

### 1.1 관리자 권한 (ADMIN)
- **접근 가능 페이지**: 대시보드, 인수인계, 시각화, 사용자 관리 (즉, 전체 페이지)
- **데이터 권한**  
  - 조회/생성/수정/삭제: 모든 항목 제한 없음  
  - 상태 변경: **5가지 상태(대기/진행/완료/이슈/취소)를 어느 방향으로든** 변경 가능(역행·롤백 포함)
- **사용자 관리**  
  - 사용자 생성, 삭제, 권한 변경 가능

### 1.2 일반 사용자 권한 (USER)
- **접근 가능 페이지**: 대시보드, 인수인계
- **데이터 권한**  
  - 조회: 모든 데이터 조회 가능  
  - 생성: 새 항목(주문, 인수인계 등) 생성 가능  
  - 수정: 행 단위 락 해제 시, 주문·인수인계 등 항목 수정 가능  
  - 삭제: 불가능 (개발 요구사항 상 일반 사용자 삭제 제한)
- **상태 변경 규칙**  
  - 대기 → 진행  
  - 진행 → 완료 / 이슈 / 취소  
  - (역행 불가)

<br />

---

## 2. 행 단위 락 (Row-Level Lock)
- **모든 데이터 변경 작업(수정, 삭제, 상태변경)** 전, 해당 레코드(행)에 대한 락이 필요
- 이미 다른 사용자가 해당 행을 점유(락) 중이면 작업 거부 & “누가 사용 중인지” 알림
- 락 획득에 성공해야 변경 가능
- 작업 완료(수정·삭제·상태변경) 후 락 해제

<br />

---

## 3. 인증 및 세션
- **로그인 필수**  
  - 인증되지 않은 상태에서 어떤 페이지에 접근하면 로그인 페이지로 자동 이동
- **로그인 성공 시**  
  - 세션 쿠키 설정 → 기본 진입 페이지인 대시보드로 이동
- **세션 만료**  
  - 특정 시간 초과 시 자동으로 로그인 페이지로 이동
- **로그아웃**  
  - 세션 삭제 후 로그인 페이지로 이동

<br />

---

## 4. 대시보드 (DashboardPage)

### 4.1 초기 로드(기본 로드값)
- **ETA(날짜) 조회 기본값**: **오늘**  
  - 페이지 마운트 시 ‘오늘 날짜’ 기준으로 DB에서 주문(ETA가 오늘인 항목)을 SSR로 불러옴
  - 이후 상태·부서·창고 필터는 클라이언트(CSR) 측에서 재필터링

### 4.2 데이터 조회 및 필터링
- **서버 조회(SSR)**  
  - 날짜(ETA) 범위가 서버로 전송되어, 그 기간의 주문만 로드
- **클라이언트 필터(CSR)**  
  - 상태, 부서, 창고는 이미 받은 데이터를 브라우저에서 재필터링
- **검색(order_no)**  
  - order_no로 DB에 직접 검색, 즉 CSR 검색이 아닌 api 호출로 백엔드 서버로직 활용

### 4.3 테이블 및 컬럼
- **기본 컬럼**:  
  - (체크박스), type, department, warehouse, order_no, SLA, ETA, region, customer, driver_name  
- **컬럼 커스터마이징**  
  - 표시할 컬럼 순서·숨김여부를 클라이언트 측에서 자유롭게 변경
- **페이지네이션**  
  - 서버에서 페이지 단위로 데이터 전송, 클라이언트는 해당 페이지 데이터만 표시

### 4.4 상세정보 모달
- 행 클릭 시 모달창 표시
- **내용**: 주문의 모든 필드, 마지막 업데이트 유저, 마지막 업데이트 시각 등
- **UI/UX**: 모달 너비를 최대화해 스크롤 최소화. 하단에 ‘수정’, ‘닫기’ 버튼 고정 표시

### 4.5 주문 생성·수정·삭제
1. **생성**  
   - 필수 입력 필드  
     - order_no, type(드롭다운), department(드롭다운), warehouse(드롭다운), SLA(문자 필드), ETA(날짜/시간), postal_code(5자리), address(텍스트), customer(문자), contact(010-xxxx-xxxx)  
     - `postal_code`: 4자리만 입력되면 앞에 ‘0’을 자동 보완(프론트/백엔드 공통)
2. **수정**  
   - 관리자는 모든 주문 수정 가능  
   - 일반 사용자도 수정 가능(단, **행 단위 락** 해제되어야 함)  
   - 마지막 수정자 및 수정 시간은 매번 갱신
3. **삭제**  
   - **일괄 삭제** 로직 적용(단일 항목 선택도 내부적으로 일괄 삭제와 동일 흐름)  
   - 관리자만 가능, 일반 사용자는 불가

### 4.6 주문 상태 변경
- 상태 종류: **대기, 진행, 완료, 이슈, 취소** (총 5가지)
- **일반 사용자(USER)**:  
  - 대기 → 진행  
  - 진행 → 완료 / 이슈 / 취소  
- **관리자(ADMIN)**:  
  - 모든 상태 간 자유 전이 가능(역행·롤백 가능)  
  - 롤백 시 알림 처리 필수
- **자동 시간 기록**  
  - 대기 → 진행 시 `depart_time` 기록  
  - 진행 → 완료/이슈/취소 시 `complete_time` 기록

### 4.7 배차(기사 배정)
- 다중 행(체크박스로 선택된 주문들)에 대해 `driver_name`을 일괄 배정 가능
- 일반 사용자도 가능하나, 락 및 권한제한 사항 고려

### 4.8 데이터 다운로드(xlsx)
- 현재 로드된 데이터(오늘 날짜 등)를 엑셀 파일 형태로 다운로드

<br />

---

## 5. 인수인계 (HandoverPage)

### 5.1 초기 로드
- 페이지 마운트 시, 인수인계/공지사항 데이터를 모두 로드
- 상단 30%는 공지사항 목록, 하단 70%는 인수인계 목록 (각각 별도 페이지네이션)

### 5.2 공지사항 vs 인수인계
- **공지사항 등록**  
  - 관리자만 체크 가능(“공지사항 등록” 체크박스)  
  - 공지사항으로 등록되면 상단 리스트에 표시
- **인수인계**  
  - 일반 사용자도 생성 가능
  - 본인이 작성한 인수인계만 수정 가능 (행 락 필요)

### 5.3 생성·수정·삭제
- **생성**  
  - 공지사항: 관리자만  
  - 인수인계: 일반 사용자 가능  
- **수정**  
  - 본인이 작성한 인수인계 수정 가능(관리자라면 모든 항목 수정 가능)  
  - 공지사항도 작성자가 관리자라면 수정 가능
- **삭제**  
  - 관리자만 가능  
  - 일반 사용자는 인수인계·공지사항 모두 삭제 불가
- **시간 기록**  
  - 최초 생성 시각: 계속 유지  
  - 업데이트 시각: 수정할 때마다 갱신  
  - 마지막 업데이트 유저와 시간은 레코드마다 표시

<br />

---

## 6. 시각화 (VisualizationPage) - 관리자 전용

### 6.1 초기 로드
- 관리자만 접근 가능
- 페이지 진입 시 “기본 기간”(예: 오늘 혹은 최근 일주일 등)으로 서버에서 데이터 로드
- 기본 그래프(시간대별 접수량 등) 자동 표시

### 6.2 시각화 종류
1. **시간대별 접수량**  
   - `create_time` 기준으로 09~18시(1시간 단위), 18~20, 20~00, 00~09 구간별 주문 건수  
   - CS/HES/LENOVO 3개 부서 각각의 건수를 막대그래프로 표시  
   - 막대 위에 실제 건수(라벨) 표시
2. **부서별 상태 현황**  
   - `ETA` 기준으로 기간 내 데이터에서 부서별 5가지 상태(대기, 진행, 완료, 이슈, 취소) 비율  
   - 부서당 파이 차트 1개씩 표시, 파이 조각에 건수 혹은 비율 라벨 표시

### 6.3 기간·그래프 유형 변경
- 기간 선택 드롭다운 → 해당 기간 데이터를 로드해 재그래프
- 그래프 유형(예: 막대, 파이) 전환 가능

<br />

---

## 7. 사용자 관리 (UserManagePage) - 관리자 전용

### 7.1 초기 로드
- 관리자만 접근 가능
- 모든 사용자 목록을 로드해 테이블 표시 (권한, ID, 이름 등)

### 7.2 사용자 관리 기능
- **사용자 추가**: ID, PW, 이름, 권한 지정  
- **사용자 삭제**: 관리자만 가능  
- **권한 변경**: 관리자가 USER → ADMIN 변경 혹은 반대 가능

<br />

---

## 8. 우편번호 처리
- **독립된 우편번호 API/로직**은 모두 삭제됨
- 주문 생성·수정 시 `postal_code`(5자리)만 입력  
- 4자리 입력 시 앞에 ‘0’을 자동으로 보완(프론트·백 동일)

<br />

---

## 9. 공통 처리 사항

### 9.1 마지막 수정자/수정 시간
- 생성, 수정, 삭제, 상태 변경 등 모든 변경 작업마다
  - **마지막 수정자**, **최종 수정 시간** 필드에 기록
- 이력 테이블 없이 **현재 정보**만 계속 갱신(덮어쓰기)

### 9.2 로그 / 알림
- **상태 롤백 시 알림 필수** (관리자 권한)
- **행 단위 락 거부 시** 어느 유저가 사용 중인지 표시

<br />

---

## 10. 결론
- **대시보드**: “오늘” ETA 기준으로 초기 로드, 상태·부서·창고는 CSR 필터  
- **인수인계**: 공지사항 겸용, 관리자/일반 사용자 권한 및 락 규칙 준수  
- **시각화**: 관리자 전용, 기본 기간 그래프 로드 후 선택적 변경  
- **사용자 관리**: 관리자 전용, 사용자 생성·삭제·권한 관리  
- **우편번호**: 5자리 숫자만 사용하며 ‘0’ 보완 로직 유지

**주의**  
1. **행 단위 락**을 반드시 준수해야 함  
2. **권한**(ADMIN / USER)에 따라 접근·기능 제한 발생  
3. **대시보드**에서의 “오늘” 날짜 필터가 기본값  
4. **삭제**는 관리자만 가능  
5. **상태 전이**는 사용자/관리자 권한에 따라 구분

