{% extends "layout.html" %}

{% block title %}사용자 관리 - TeckWahKRTMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/users.css">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <header class="dashboard-header">
        <div class="header-left">
            <img src="/static/images/logo.png" alt="Logo" class="header-logo">
            <h1 class="header-title">배송 관제 시스템</h1>
        </div>
        <div class="header-right">
            <span class="user-info">{{ user.user_department }} | {{ user.user_id }} ({{ '관리자' if user.user_role == 'ADMIN' else '일반사용자' }})</span>
            <button class="logout-button" onclick="logout()">로그아웃</button>
        </div>
    </header>

    <nav class="dashboard-nav">
        <ul class="nav-menu">
            <li class="nav-item"><a href="/dashboard">대시보드</a></li>
            <li class="nav-item"><a href="/handover">인수인계</a></li>
            {% if user.user_role == 'ADMIN' %}
            <li class="nav-item"><a href="/visualization">데이터 시각화</a></li>
            <li class="nav-item active"><a href="/users">사용자 관리</a></li>
            {% endif %}
        </ul>
    </nav>

    <main class="dashboard-content">
        <div class="users-container">
            <section class="users-header">
                <h2 class="section-title">사용자 관리</h2>
                <button class="create-button" onclick="openCreateModal()">사용자 추가</button>
            </section>

            <section class="users-filters">
                <form id="filterForm" class="filter-form">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="role">권한</label>
                            <select id="role" name="role">
                                <option value="all" {% if filter.role == 'all' %}selected{% endif %}>전체</option>
                                <option value="ADMIN" {% if filter.role == 'ADMIN' %}selected{% endif %}>관리자</option>
                                <option value="USER" {% if filter.role == 'USER' %}selected{% endif %}>일반사용자</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="search_type">검색</label>
                            <select id="search_type" name="search_type">
                                <option value="user_id" {% if filter.search_type == 'user_id' %}selected{% endif %}>아이디</option>
                                <option value="user_name" {% if filter.search_type == 'user_name' %}selected{% endif %}>이름</option>
                                <option value="user_department" {% if filter.search_type == 'user_department' %}selected{% endif %}>부서</option>
                            </select>
                            <input type="text" id="search_value" name="search_value" value="{{ filter.search_value }}" placeholder="검색어 입력">
                        </div>
                    </div>
                    <div class="filter-buttons">
                        <button type="submit" class="search-button">검색</button>
                        <button type="button" class="reset-button" onclick="resetFilters()">초기화</button>
                    </div>
                </form>
            </section>

            <section class="users-list">
                <div id="alertContainer" class="alert-container"></div>
                
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>아이디</th>
                            <th>이름</th>
                            <th>부서</th>
                            <th>권한</th>
                            <th>상태</th>
                            <th>생성일시</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_item in users %}
                        <tr data-id="{{ user_item.user_id }}" class="user-row">
                            <td>{{ user_item.user_id }}</td>
                            <td>{{ user_item.user_name }}</td>
                            <td>{{ user_item.user_department }}</td>
                            <td>
                                <span class="role-badge {{ 'admin' if user_item.user_role == 'ADMIN' else 'user' }}">
                                    {{ '관리자' if user_item.user_role == 'ADMIN' else '일반사용자' }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge {{ 'active' if user_item.user_status == 'ACTIVE' else 'inactive' }}">
                                    {{ '활성화' if user_item.user_status == 'ACTIVE' else '비활성화' }}
                                </span>
                            </td>
                            <td>{{ user_item.created_at }}</td>
                            <td>
                                <button class="edit-button" onclick="editUser('{{ user_item.user_id }}')">수정</button>
                                <button class="status-button {{ 'inactive-button' if user_item.user_status == 'ACTIVE' else 'active-button' }}" 
                                    onclick="toggleUserStatus('{{ user_item.user_id }}', '{{ user_item.user_status }}')">
                                    {{ '비활성화' if user_item.user_status == 'ACTIVE' else '활성화' }}
                                </button>
                                <button class="reset-pw-button" onclick="resetPassword('{{ user_item.user_id }}')">비밀번호 초기화</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="no-results">사용자 정보가 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- 페이지네이션 -->
                {% if total_pages > 1 %}
                <div class="pagination">
                    {% if current_page > 1 %}
                    <a href="?page={{ current_page - 1 }}" class="pagination-arrow">&lt;</a>
                    {% endif %}
                    
                    {% for page in range(1, total_pages + 1) %}
                        {% if page == current_page %}
                        <span class="pagination-current">{{ page }}</span>
                        {% else %}
                        <a href="?page={{ page }}" class="pagination-link">{{ page }}</a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if current_page < total_pages %}
                    <a href="?page={{ current_page + 1 }}" class="pagination-arrow">&gt;</a>
                    {% endif %}
                </div>
                {% endif %}
            </section>
        </div>

        <!-- 사용자 생성/수정 모달 -->
        <div id="userFormModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">사용자 추가</h2>
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="userForm" class="user-form">
                        <input type="hidden" id="isEdit" name="isEdit" value="false">
                        <div class="form-group">
                            <label for="user_id">아이디</label>
                            <input type="text" id="user_id" name="user_id" required>
                        </div>
                        <div class="form-group">
                            <label for="user_name">이름</label>
                            <input type="text" id="user_name" name="user_name" required>
                        </div>
                        <div class="form-group">
                            <label for="user_department">부서</label>
                            <input type="text" id="user_department" name="user_department" required>
                        </div>
                        <div class="form-group">
                            <label for="user_role">권한</label>
                            <select id="user_role" name="user_role" required>
                                <option value="USER">일반사용자</option>
                                <option value="ADMIN">관리자</option>
                            </select>
                        </div>
                        <div id="passwordFields">
                            <div class="form-group">
                                <label for="user_password">비밀번호</label>
                                <input type="password" id="user_password" name="user_password">
                            </div>
                            <div class="form-group">
                                <label for="confirm_password">비밀번호 확인</label>
                                <input type="password" id="confirm_password" name="confirm_password">
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="submit-button">저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 비밀번호 초기화 확인 모달 -->
        <div id="resetPasswordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>비밀번호 초기화</h2>
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p>선택한 사용자의 비밀번호를 초기화하시겠습니까?</p>
                    <p>초기화 후 비밀번호: <strong>TMS12345</strong></p>
                    <div class="form-group">
                        <input type="hidden" id="resetUserId" value="">
                        <button class="submit-button" onclick="confirmResetPassword()">초기화</button>
                        <button class="cancel-button" onclick="closeModal()">취소</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 상태 변경 확인 모달 -->
        <div id="statusChangeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="statusChangeTitle">사용자 상태 변경</h2>
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="statusChangeMessage">사용자 상태를 변경하시겠습니까?</p>
                    <div class="form-group">
                        <input type="hidden" id="statusChangeUserId" value="">
                        <input type="hidden" id="statusChangeAction" value="">
                        <button class="submit-button" onclick="confirmStatusChange()">확인</button>
                        <button class="cancel-button" onclick="closeModal()">취소</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="dashboard-footer">
        <p>© 2025 TeckWahKR Operation Team. All rights reserved.</p>
    </footer>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/users.js"></script>
{% endblock %} 