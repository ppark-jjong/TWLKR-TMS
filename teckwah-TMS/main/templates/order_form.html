{% extends "base.html" %} {% block title %}{% if is_edit %}주문 수정{% else
%}신규 주문 등록{% endif %} - Teckwah TMS{% endblock %} {% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/orders.css') }}" />
{% endblock %} {% block content %} {# JavaScript에서 파싱할 JSON 데이터 포함 #}
<script id="initial-data-script" type="application/json">
  {{ initial_data_json|safe }}
</script>

<div class="order-form-page">
  <div class="page-header">
    <h1 class="page-title">
      {# JS에서 제목 동적 설정 #}
      <i class="fa-solid" id="pageIcon"></i>
      <span id="pageTitle"
        >{% if is_edit %}주문 정보 수정{% else %}신규 배송 등록{% endif %}</span
      >
    </h1>
    <div class="header-actions">
      {# JS에서 취소 버튼 링크 동적 설정 #}
      <a href="#" class="btn secondary-btn" id="cancelBtn">
        <i class="fa-solid fa-times"></i>
        취소
      </a>
      {# JS에서 저장 버튼 텍스트/상태 동적 설정 #}
      <button
        type="submit"
        form="orderForm"
        class="btn primary-btn"
        id="submitBtn"
      >
        <i class="fa-solid fa-check"></i>
        <span id="submitBtnText"
          >{% if is_edit %}저장{% else %}등록하기{% endif %}</span
        >
      </button>
    </div>
  </div>

  {# ... 경고/오류 메시지 표시 ... #}
  <div id="alert-placeholder"></div>
  {# JS에서 동적 추가 #}

  <div class="main-card">
    {# form id 및 action은 JS에서 설정 또는 기본값 사용 후 JS 수정 #}
    <form id="orderForm" method="POST" class="order-form two-column-form">
      {# hidden input은 JS에서 필요시 추가 #}

      <div class="form-section">
        <h3 class="section-title">기본 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="order_no">주문번호 <span class="required">*</span></label>
            <input
              type="text"
              id="order_no"
              name="order_no"
              class="input-field"
              value="{{ order.orderNo if is_edit else '' }}"
              required
              {% if is_edit %}readonly{% endif %}
            />
          </div>
          <div class="form-group">
            <label for="type">유형 <span class="required">*</span></label>
            <select id="type" name="type" class="select-field" required {% if is_edit and not order.editable %}disabled{% endif %}>
              <option value="DELIVERY" {% if is_edit and order.type == 'DELIVERY' %}selected{% endif %}>배송</option>
              <option value="RETURN" {% if is_edit and order.type == 'RETURN' %}selected{% endif %}>회수</option>
            </select>
          </div>
          <div class="form-group">
            <label for="department">부서 <span class="required">*</span></label>
            <select id="department" name="department" class="select-field" required {% if is_edit and not order.editable %}disabled{% endif %}>
              <option value="CS" {% if is_edit and order.department == 'CS' %}selected{% endif %}>CS</option>
              <option value="HES" {% if is_edit and order.department == 'HES' %}selected{% endif %}>HES</option>
              <option value="LENOVO" {% if is_edit and order.department == 'LENOVO' %}selected{% endif %}>LENOVO</option>
            </select>
          </div>
          <div class="form-group">
            <label for="warehouse">창고 <span class="required">*</span></label>
            <select id="warehouse" name="warehouse" class="select-field" required {% if is_edit and not order.editable %}disabled{% endif %}>
              <option value="SEOUL" {% if is_edit and order.warehouse == 'SEOUL' %}selected{% endif %}>서울</option>
              <option value="BUSAN" {% if is_edit and order.warehouse == 'BUSAN' %}selected{% endif %}>부산</option>
              <option value="GWANGJU" {% if is_edit and order.warehouse == 'GWANGJU' %}selected{% endif %}>광주</option>
              <option value="DAEJEON" {% if is_edit and order.warehouse == 'DAEJEON' %}selected{% endif %}>대전</option>
            </select>
          </div>
          <div class="form-group">
            <label for="sla">SLA <span class="required">*</span></label>
            <input
              type="text"
              id="sla"
              name="sla"
              class="input-field"
              value="{{ order.sla if is_edit else '' }}"
              required
              {% if is_edit and not order.editable %}disabled{% endif %}
            />
          </div>
          <div class="form-group">
            <label for="eta">ETA <span class="required">*</span></label>
            <input
              type="datetime-local"
              id="eta"
              name="eta"
              class="input-field"
              value="{{ order.eta.strftime('%Y-%m-%dT%H:%M') if is_edit and order.eta else '' }}"
              required
              {% if is_edit and not order.editable %}disabled{% endif %}
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">배송 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="postal_code">우편번호 <span class="required">*</span></label>
            <input
              type="text"
              id="postal_code"
              name="postal_code"
              class="input-field"
              value="{{ order.postalCode if is_edit else '' }}"
              maxlength="5"
              required
              {% if is_edit and not order.editable %}disabled{% endif %}
            />
          </div>
          <div class="form-group">
            <label for="customer">고객명 <span class="required">*</span></label>
            <input
              type="text"
              id="customer"
              name="customer"
              class="input-field"
              value="{{ order.customer if is_edit else '' }}"
              required
              {% if is_edit and not order.editable %}disabled{% endif %}
            />
          </div>
        </div>
        <div class="form-group form-group-full-width">
          <label for="address">주소 <span class="required">*</span></label>
          <input
            type="text"
            id="address"
            name="address"
            class="input-field"
            value="{{ order.address if is_edit else '' }}"
            required
            {% if is_edit and not order.editable %}disabled{% endif %}
          />
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="contact">연락처</label>
            <input
              type="text"
              id="contact"
              name="contact"
              class="input-field"
              value="{{ order.contact if is_edit else '' }}"
              {% if is_edit and not order.editable %}disabled{% endif %}
            />
          </div>
          <div class="form-group">
            <label for="status">상태 <span class="required">*</span></label>
            <select
              id="status"
              name="status"
              class="select-field"
              required
              {% if is_edit and not order.editable %}disabled{% endif %}
            >
              <option value="WAITING" {% if is_edit and order.status == 'WAITING' %}selected{% endif %}>대기</option>
              <option value="IN_PROGRESS" {% if is_edit and order.status == 'IN_PROGRESS' %}selected{% endif %}>진행</option>
              <option value="COMPLETE" {% if is_edit and order.status == 'COMPLETE' %}selected{% endif %}>완료</option>
              <option value="ISSUE" {% if is_edit and order.status == 'ISSUE' %}selected{% endif %}>이슈</option>
              <option value="CANCEL" {% if is_edit and order.status == 'CANCEL' %}selected{% endif %}>취소</option>
            </select>
          </div>
        </div>
      </div>

      {# Driver section hidden #}
      <div class="form-section">
        <h3 class="section-title">기사 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="driver_name">기사명</label>
            <input
              type="text"
              id="driver_name"
              name="driver_name"
              class="input-field"
              value="{{ order.driverName if is_edit else '' }}"
              {% if is_edit and not order.editable %}disabled{% endif %}
            />
          </div>
          <div class="form-group">
            <label for="driver_contact">기사 연락처</label>
            <input
              type="text"
              id="driver_contact"
              name="driver_contact"
              class="input-field"
              value="{{ order.driverContact if is_edit else '' }}"
              {% if is_edit and not order.editable %}disabled{% endif %}
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">추가 정보</h3>
        <div class="form-group form-group-full-width">
          <label for="remark">메모</label>
          <textarea
            id="remark"
            name="remark"
            class="text-area"
            rows="3"
            {% if is_edit and not order.editable %}disabled{% endif %}
          >{{ order.remark if is_edit else '' }}</textarea>
        </div>
      </div>

      {# 업데이트 정보 영역 (수정 시에만 JS로 추가) #}
      <div id="update-info-section-placeholder"></div>
    </form>
  </div>
</div>
{% endblock %} {% block page_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let initialData = {};
    try {
      const jsonDataElement = document.getElementById('initial-data-script');
      initialData = JSON.parse(jsonDataElement.textContent || '{}');
    } catch (e) {
      console.error('Failed to parse initial data JSON:', e);
      // 오류 처리 (예: 사용자에게 메시지 표시)
      Utils.alerts.showError('페이지 데이터 로딩 오류');
      return; // 초기화 중단
    }

    const isEditMode = initialData.is_edit;
    const order = initialData.order;
    const currentUserRole = initialData.current_user_role;
    const lockStatus = initialData.lock_status; // 수정 모드일 때만 유효
    const statusOptions = initialData.status_options; // 수정 모드일 때만 유효

    const form = document.getElementById('orderForm');
    const pageIcon = document.getElementById('pageIcon');
    const pageTitle = document.getElementById('pageTitle');
    const cancelBtn = document.getElementById('cancelBtn');
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const alertPlaceholder = document.getElementById('alert-placeholder');
    const updateInfoPlaceholder = document.getElementById(
      'update-info-section-placeholder'
    );

    // --- UI 및 폼 초기 설정 ---
    function initializeForm() {
      // 1. 제목, 아이콘, 액션 URL, 버튼 텍스트 설정
      pageIcon.className = `fa-solid ${isEditMode ? 'fa-edit' : 'fa-plus'}`;
      pageTitle.textContent = isEditMode ? '주문 정보 수정' : '신규 배송 등록';
      form.action = isEditMode ? `/api/orders/${order.dashboardId}` : '/api/orders';
      submitBtnText.textContent = isEditMode ? '저장' : '등록하기';
      cancelBtn.href = isEditMode ? `/orders/${order.dashboardId}` : '/dashboard';

      // 2. 필드 값 채우기 및 상태 설정 (수정 모드)
      if (isEditMode && order) {
        // 기본 정보
        form.order_no.value = order.orderNo || '';
        form.order_no.readOnly = true;
        form.type.value = order.type || 'DELIVERY';
        form.department.value = order.department || 'CS';
        form.warehouse.value = order.warehouse || 'SEOUL';
        form.sla.value = order.sla || '';
        form.eta.value = order.eta ? order.eta.substring(0, 16) : ''; // YYYY-MM-DDTHH:MM

        // 배송 정보
        form.postal_code.value = order.postalCode || '';
        form.customer.value = order.customer || '';
        form.address.value = order.address || '';
        form.contact.value = order.contact || '';

        // 상태 (Select 값 설정)
        const statusSelect = document.getElementById('status');
        if (statusSelect) statusSelect.value = order.status || 'WAITING';

        // 기사 정보 (Input 값 설정)
        const driverNameInput = document.getElementById('driver_name');
        const driverContactInput = document.getElementById('driver_contact');
        if (driverNameInput) driverNameInput.value = order.driverName || '';
        if (driverContactInput) driverContactInput.value = order.driverContact || '';

        // 메모
        form.remark.value = order.remark || '';

        // 수정 불가능 상태 처리 (락 걸렸을 때)
        if (!order.editable) {
          disableFormFields(true);
          submitBtn.disabled = true;
          showAlert(
            'warning',
            `주의: 이 주문은 현재 다른 사용자(${order.lockedBy || '알 수 없음'})가 수정 중입니다.`
          );
        }

        // 업데이트 정보 표시
        renderUpdateInfo();
      } else {
        // 생성 모드: ETA 기본값 설정 등
        const etaInput = document.getElementById('eta');
        if (etaInput && !etaInput.value) {
          const now = new Date();
          const timezoneOffset = now.getTimezoneOffset() * 60000; // offset in milliseconds
          const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
          etaInput.value = localISOTime;
        }
        // 상태, 기사 필드 readonly 적용
        document.getElementById('status_display').readOnly = true;
        document.getElementById('driver_name').readOnly = true;
        document.getElementById('driver_contact').readOnly = true;
      }

      // 우편번호 자동 보완 리스너
      const postalCodeInput = document.getElementById('postal_code');
      if (postalCodeInput) {
        postalCodeInput.addEventListener('blur', formatPostalCodeOnBlur);
      }
    }

    // 폼 필드 비활성화/활성화
    function disableFormFields(disabled) {
      const fields = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
      fields.forEach((field) => {
        // 주문번호는 수정 모드에서 항상 readonly
        if (!(field.id === 'order_no' && isEditMode)) {
          field.disabled = disabled;
        }
      });
    }

    // 경고/오류 메시지 표시
    function showAlert(type, message) {
      alertPlaceholder.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
    }

    // 업데이트 정보 렌더링
    function renderUpdateInfo() {
      if (updateInfoPlaceholder && order && order.updateAt) {
        updateInfoPlaceholder.innerHTML = `
          <div class="form-section update-info-section">
            <h3 class="section-title">업데이트 정보</h3>
            <div class="form-grid">
              <div class="form-group">
                <label>최근 업데이트</label>
                <p class="form-control-static">${Utils.formatDate(order.updateAt)}</p>
              </div>
              <div class="form-group">
                <label>수정자</label>
                <p class="form-control-static">${order.updatedBy || '-'}</p>
              </div>
            </div>
          </div>`;
      }
    }

    // 우편번호 자동 보완 핸들러
    function formatPostalCodeOnBlur() {
      const value = this.value.trim();
      if (value.length === 4 && /^\d{4}$/.test(value)) {
        this.value = '0' + value;
      }
    }

    // 우편번호 유효성 검사 및 형식화
    const postalCodeInput = document.getElementById('postal_code');
    if (postalCodeInput) {
      // 입력 제한: 숫자만 입력 가능, 최대 5자리
      postalCodeInput.addEventListener('input', function(e) {
        // 숫자만 허용
        this.value = this.value.replace(/[^\d]/g, '');
        
        // 5자 이상 입력 방지
        if (this.value.length > 5) {
          this.value = this.value.slice(0, 5);
        }
        
        // 유효성 검사 결과에 따른 스타일 변경
        if (this.value.length === 5) {
          this.classList.remove('input-error');
          const errorMsg = this.parentNode.querySelector('.error-message');
          if (errorMsg) errorMsg.remove();
        } else if (this.value.length > 0) {
          this.classList.add('input-error');
          let errorMsg = this.parentNode.querySelector('.error-message');
          if (!errorMsg) {
            errorMsg = document.createElement('span');
            errorMsg.className = 'error-message';
            this.parentNode.appendChild(errorMsg);
          }
          errorMsg.textContent = '우편번호는 5자리 숫자여야 합니다.';
        }
      });
    }

    // 연락처 자동 하이픈 포맷팅
    const contactInput = document.getElementById('contact');
    if (contactInput) {
      contactInput.addEventListener('input', function() {
        // 숫자만 허용
        const numericValue = this.value.replace(/[^\d]/g, '');
        // 하이픈 포맷팅 적용
        this.value = Utils.formatPhoneNumber(numericValue);
      });
    }
    
    // 기사 연락처 자동 하이픈 포맷팅
    const driverContactInput = document.getElementById('driver_contact');
    if (driverContactInput) {
      driverContactInput.addEventListener('input', function() {
        // 숫자만 허용
        const numericValue = this.value.replace(/[^\d]/g, '');
        // 하이픈 포맷팅 적용
        this.value = Utils.formatPhoneNumber(numericValue);
      });
    }

    // --- 폼 제출 처리 ---
    if (form) {
      form.addEventListener('submit', function (e) {
        // 우편번호 유효성 검사
        if (postalCodeInput && !Utils.validatePostalCode(postalCodeInput.value)) {
          e.preventDefault();
          postalCodeInput.classList.add('input-error');
          postalCodeInput.focus();
          
          let errorMsg = postalCodeInput.parentNode.querySelector('.error-message');
          if (!errorMsg) {
            errorMsg = document.createElement('span');
            errorMsg.className = 'error-message';
            postalCodeInput.parentNode.appendChild(errorMsg);
          }
          errorMsg.textContent = '우편번호는 5자리 숫자여야 합니다.';
          
          Utils.alerts.showWarning('우편번호는 5자리 숫자로 입력해주세요.');
          return false;
        }
      
        // 로딩 상태 표시
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${
            isEditMode ? '저장 중...' : '등록 중...'
          }`;
        }
        // 기본 Form 제출 사용 (JS fetch 제거됨)
      });
    }

    // --- 초기화 실행 ---
    initializeForm();
  });
</script>
{% endblock %}
