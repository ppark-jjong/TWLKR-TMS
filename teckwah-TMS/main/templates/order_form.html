{% extends "base.html" %} {% block title %}{% if is_edit %}주문 수정{% else
%}신규 주문 등록{% endif %} - Teckwah TMS{% endblock %} {% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/orders.css') }}" />
{% endblock %} {% block content %}

<div class="order-form-page">
  <div class="page-header">
    <h1 class="page-title">
      <i class="fa-solid {% if is_edit %}fa-edit{% else %}fa-plus{% endif %}"></i>
      <span>{% if is_edit %}주문 정보 수정{% else %}신규 배송 등록{% endif %}</span>
    </h1>
    <div class="header-actions">
      <a href="{% if is_edit %}/orders/{{ order.dashboard_id }}{% else %}/dashboard{% endif %}" class="btn secondary-btn">
        <i class="fa-solid fa-times"></i>
        취소
      </a>
      <button
        type="submit"
        form="orderForm"
        class="btn primary-btn"
        id="submitBtn"
      >
        <i class="fa-solid fa-check"></i>
        <span>{% if is_edit %}저장{% else %}등록하기{% endif %}</span>
      </button>
    </div>
  </div>

  {% if error_message %}
  <div class="alert alert-danger">
    <i class="fa-solid fa-circle-exclamation"></i>
    {{ error_message }}
  </div>
  {% endif %}
  
  {% if success_message %}
  <div class="alert alert-success">
    <i class="fa-solid fa-circle-check"></i>
    {{ success_message }}
  </div>
  {% endif %}

  <div class="main-card">
    <form id="orderForm" method="POST" class="order-form two-column-form" 
          action="{% if is_edit %}/api/orders/{{ order.dashboard_id }}{% else %}/api/orders{% endif %}">
      <div class="form-section">
        <h3 class="section-title">기본 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="order_no">주문번호 <span class="required">*</span></label>
            <input
              type="text"
              id="order_no"
              name="order_no"
              class="input-field"
              value="{{ order.order_no if is_edit else '' }}"
              required
              {% if is_edit %}readonly{% endif %}
            />
          </div>
          <div class="form-group">
            <label for="type">유형 <span class="required">*</span></label>
            <select id="type" name="type" class="select-field" required>
              <option value="DELIVERY" {% if is_edit and order.type == 'DELIVERY' %}selected{% endif %}>배송</option>
              <option value="RETURN" {% if is_edit and order.type == 'RETURN' %}selected{% endif %}>회수</option>
            </select>
          </div>
          <div class="form-group">
            <label for="department">부서 <span class="required">*</span></label>
            <select id="department" name="department" class="select-field" required>
              <option value="CS" {% if is_edit and order.department == 'CS' %}selected{% endif %}>CS</option>
              <option value="HES" {% if is_edit and order.department == 'HES' %}selected{% endif %}>HES</option>
              <option value="LENOVO" {% if is_edit and order.department == 'LENOVO' %}selected{% endif %}>LENOVO</option>
            </select>
          </div>
          <div class="form-group">
            <label for="warehouse">창고 <span class="required">*</span></label>
            <select id="warehouse" name="warehouse" class="select-field" required>
              <option value="SEOUL" {% if is_edit and order.warehouse == 'SEOUL' %}selected{% endif %}>서울</option>
              <option value="BUSAN" {% if is_edit and order.warehouse == 'BUSAN' %}selected{% endif %}>부산</option>
              <option value="GWANGJU" {% if is_edit and order.warehouse == 'GWANGJU' %}selected{% endif %}>광주</option>
              <option value="DAEJEON" {% if is_edit and order.warehouse == 'DAEJEON' %}selected{% endif %}>대전</option>
            </select>
          </div>
          <div class="form-group">
            <label for="sla">SLA <span class="required">*</span></label>
            <input
              type="text"
              id="sla"
              name="sla"
              class="input-field"
              value="{{ order.sla if is_edit else '' }}"
              required
            />
          </div>
          <div class="form-group">
            <label for="eta">ETA <span class="required">*</span></label>
            <input
              type="datetime-local"
              id="eta"
              name="eta"
              class="input-field"
              value="{{ order.eta.strftime('%Y-%m-%dT%H:%M') if is_edit and order.eta else '' }}"
              required
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">배송 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="postal_code">우편번호 <span class="required">*</span></label>
            <input
              type="text"
              id="postal_code"
              name="postal_code"
              class="input-field"
              value="{{ order.postal_code if is_edit else '' }}"
              maxlength="5"
              required
            />
          </div>
          <div class="form-group">
            <label for="customer">고객명 <span class="required">*</span></label>
            <input
              type="text"
              id="customer"
              name="customer"
              class="input-field"
              value="{{ order.customer if is_edit else '' }}"
              required
            />
          </div>
        </div>
        <div class="form-group form-group-full-width">
          <label for="address">주소 <span class="required">*</span></label>
          <input
            type="text"
            id="address"
            name="address"
            class="input-field"
            value="{{ order.address if is_edit else '' }}"
            required
          />
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="contact">연락처</label>
            <input
              type="text"
              id="contact"
              name="contact"
              class="input-field"
              value="{{ order.contact if is_edit else '' }}"
            />
          </div>
          <div class="form-group">
            <label for="status">상태 <span class="required">*</span></label>
            <select
              id="status"
              name="status"
              class="select-field"
              required
            >
              <option value="WAITING" {% if is_edit and order.status == 'WAITING' %}selected{% endif %}>대기</option>
              <option value="IN_PROGRESS" {% if is_edit and order.status == 'IN_PROGRESS' %}selected{% endif %}>진행</option>
              <option value="COMPLETE" {% if is_edit and order.status == 'COMPLETE' %}selected{% endif %}>완료</option>
              <option value="ISSUE" {% if is_edit and order.status == 'ISSUE' %}selected{% endif %}>이슈</option>
              <option value="CANCEL" {% if is_edit and order.status == 'CANCEL' %}selected{% endif %}>취소</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">기사 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="driver_name">기사명</label>
            <input
              type="text"
              id="driver_name"
              name="driver_name"
              class="input-field"
              value="{{ order.driver_name if is_edit else '' }}"
            />
          </div>
          <div class="form-group">
            <label for="driver_contact">기사 연락처</label>
            <input
              type="text"
              id="driver_contact"
              name="driver_contact"
              class="input-field"
              value="{{ order.driver_contact if is_edit else '' }}"
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">추가 정보</h3>
        <div class="form-group form-group-full-width">
          <label for="remark">메모</label>
          <textarea
            id="remark"
            name="remark"
            class="text-area"
            rows="3"
          >{{ order.remark if is_edit else '' }}</textarea>
        </div>
      </div>

      <div id="update-info-section-placeholder"></div>
    </form>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 우편번호 자동 포맷팅 및 유효성 검사
    const postalCodeInput = document.getElementById('postal_code');
    if (postalCodeInput) {
      // 입력 제한: 숫자만 입력 가능, 최대 5자리
      postalCodeInput.addEventListener('input', function(e) {
        // 숫자만 허용
        this.value = this.value.replace(/[^\d]/g, '');
        
        // 5자 이상 입력 방지
        if (this.value.length > 5) {
          this.value = this.value.slice(0, 5);
        }
      });

      // 자동 포맷팅: 4자리만 입력한 경우 앞에 0 붙이기
      postalCodeInput.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value.length === 4 && /^\d{4}$/.test(value)) {
          this.value = '0' + value;
        }
      });
    }

    // 연락처 자동 하이픈 포맷팅
    const contactInput = document.getElementById('contact');
    if (contactInput) {
      contactInput.addEventListener('input', function() {
        // 숫자만 허용
        const numericValue = this.value.replace(/[^\d]/g, '');
        // 하이픈 포맷팅 적용
        this.value = Utils.formatPhoneNumber(numericValue);
      });
    }
    
    // 기사 연락처 자동 하이픈 포맷팅
    const driverContactInput = document.getElementById('driver_contact');
    if (driverContactInput) {
      driverContactInput.addEventListener('input', function() {
        // 숫자만 허용
        const numericValue = this.value.replace(/[^\d]/g, '');
        // 하이픈 포맷팅 적용
        this.value = Utils.formatPhoneNumber(numericValue);
      });
    }

    // 폼 제출 처리
    const form = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form) {
      form.addEventListener('submit', function (e) {
        // 우편번호 유효성 검사
        if (postalCodeInput && postalCodeInput.value.length !== 5) {
          e.preventDefault();
          Utils.alerts.showWarning('우편번호는 5자리 숫자로 입력해주세요.');
          postalCodeInput.focus();
          return false;
        }
      
        // 로딩 상태 표시
        if (submitBtn) {
          submitBtn.disabled = true;
          const isEdit = "{{ is_edit }}" === "True";
          submitBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${
            isEdit ? '저장 중...' : '등록 중...'
          }`;
        }
      });
    }
  });
</script>
{% endblock %}
