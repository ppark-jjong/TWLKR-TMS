{% extends "base.html" %}

{% block title %}신규 주문 등록 - Teckwah TMS{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/orders.css') }}">
{% endblock %}

{% block content %}
<div class="order-form-page">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fa-solid fa-plus"></i>
            신규 배송 등록
        </h1>
        <div class="header-actions">
            <a href="/dashboard" class="btn secondary-btn">
                <i class="fa-solid fa-times"></i>
                취소
            </a>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-error">
        <i class="fa-solid fa-exclamation-circle"></i>
        <div class="alert-content">
            <strong>오류:</strong> {{ error }}
        </div>
    </div>
    {% endif %}
    
    <div class="main-card">
        <form id="newOrderForm" action="/api/orders" method="POST" class="order-form">
            <div class="form-section">
                <h3 class="section-title">기본 정보</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="order_no">주문번호 <span class="required">*</span></label>
                        <input type="text" id="order_no" name="order_no" class="input-field" placeholder="주문번호를 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="type">유형 <span class="required">*</span></label>
                        <select id="type" name="type" class="select-field" required>
                            <option value="DELIVERY">배송</option>
                            <option value="RETURN">회수</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="department">부서 <span class="required">*</span></label>
                        <select id="department" name="department" class="select-field" required>
                            <option value="CS">CS</option>
                            <option value="HES">HES</option>
                            <option value="LENOVO">LENOVO</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="warehouse">창고 <span class="required">*</span></label>
                        <select id="warehouse" name="warehouse" class="select-field" required>
                            <option value="SEOUL">서울</option>
                            <option value="BUSAN">부산</option>
                            <option value="GWANGJU">광주</option>
                            <option value="DAEJEON">대전</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="sla">SLA <span class="required">*</span></label>
                        <input type="text" id="sla" name="sla" class="input-field" placeholder="SLA를 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="eta">ETA <span class="required">*</span></label>
                        <input type="datetime-local" id="eta" name="eta" class="input-field" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">배송 정보</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="postal_code">우편번호 <span class="required">*</span></label>
                        <input type="text" id="postal_code" name="postal_code" class="input-field" placeholder="우편번호를 입력하세요" maxlength="5" required>
                        <small class="help-text">5자리 우편번호를 입력하세요. 4자리 입력 시 앞에 0이 자동으로 추가됩니다.</small>
                    </div>
                    <div class="form-group">
                        <label for="customer">고객명 <span class="required">*</span></label>
                        <input type="text" id="customer" name="customer" class="input-field" placeholder="고객명을 입력하세요" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">주소 <span class="required">*</span></label>
                    <input type="text" id="address" name="address" class="input-field" placeholder="주소를 입력하세요" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="contact">연락처</label>
                        <input type="text" id="contact" name="contact" class="input-field" placeholder="연락처를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label for="status">상태</label>
                        <select id="status" name="status" class="select-field">
                            <option value="WAITING" selected>대기</option>
                            {% if user.user_role == 'ADMIN' %}
                            <option value="IN_PROGRESS">진행</option>
                            <option value="COMPLETE">완료</option>
                            <option value="ISSUE">이슈</option>
                            <option value="CANCEL">취소</option>
                            {% endif %}
                        </select>
                        {% if user.user_role != 'ADMIN' %}
                        <small class="help-text">새 주문은 기본적으로 '대기' 상태로 생성됩니다.</small>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">기사 정보</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="driver_name">기사명</label>
                        <input type="text" id="driver_name" name="driver_name" class="input-field" placeholder="기사명을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label for="driver_contact">기사 연락처</label>
                        <input type="text" id="driver_contact" name="driver_contact" class="input-field" placeholder="기사 연락처를 입력하세요">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">추가 정보</h3>
                
                <div class="form-group">
                    <label for="remark">메모</label>
                    <textarea id="remark" name="remark" class="text-area" placeholder="필요한 메모를 입력하세요" rows="3"></textarea>
                </div>
            </div>

            <div class="form-actions">
                <a href="/dashboard" class="btn secondary-btn">취소</a>
                <button type="submit" class="btn primary-btn">
                    <i class="fa-solid fa-check"></i> 등록하기
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 현재 시간 ETA 기본값으로 설정
    const etaInput = document.getElementById('eta');
    if (etaInput) {
        // 현재 날짜/시간을 YYYY-MM-DDTHH:MM 형식으로 변환
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        etaInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // 우편번호 자동 보완
    const postalCodeInput = document.getElementById('postal_code');
    if (postalCodeInput) {
        postalCodeInput.addEventListener('blur', function() {
            // 4자리 우편번호 입력 시 5자리로 자동 보완
            const value = this.value.trim();
            if (value.length === 4 && /^\d{4}$/.test(value)) {
                this.value = '0' + value;
            }
        });
    }
    
    // 폼 제출 이벤트
    const orderForm = document.getElementById('newOrderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 폼 데이터 수집
            const formData = new FormData(orderForm);
            const jsonData = {};
            
            for (const [key, value] of formData.entries()) {
                jsonData[key] = value;
            }
            
            try {
                // 로딩 상태 표시
                const submitBtn = orderForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 등록 중...';
                
                // API 요청
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                });
                
                // 응답 처리
                const result = await response.json();
                
                if (result.success) {
                    // 성공 시 대시보드로 이동
                    window.location.href = `/dashboard?success=주문이 성공적으로 등록되었습니다`;
                } else {
                    // 실패 시 에러 메시지 표시
                    Utils.message.error(result.message || '주문 등록에 실패했습니다.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fa-solid fa-check"></i> 등록하기';
                }
            } catch (error) {
                console.error('주문 등록 중 오류:', error);
                Utils.message.error('주문 등록 중 오류가 발생했습니다.');
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-check"></i> 등록하기';
            }
        });
    }
});
</script>
{% endblock %}
