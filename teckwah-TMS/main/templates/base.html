<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Teckwah TMS{% endblock %}</title>

    <!-- 파비콘 -->
    <link
      rel="icon"
      href="{{ url_for('static', path='images/favicon.ico') }}"
      type="image/x-icon"
    />

    <!-- 기본 스타일시트 -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='css/base.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='css/layout.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', path='css/components.css') }}"
    />

    <!-- 폰트어썸 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />

    <!-- 페이지별 CSS -->
    {% block page_css %}{% endblock %}
  </head>
  <body>
    <div class="app">
      <!-- 레이아웃 -->
      <div class="main-layout">
        <!-- 사이드바 -->
        <aside class="sidebar">
          <div class="logo-container">
            <h1 class="system-title">TWLKR-TMS</h1>
            <img
              class="logo-image"
              src="{{ url_for('static', path='images/logo.png') }}"
              alt="Teckwah 로고"
            />
          </div>

          <div class="user-info">
            <div class="avatar">
              <i class="fa-solid fa-user"></i>
            </div>
            <div class="user-details">
              <p class="user-name" id="userDisplayName">{{ user.user_name }}</p>
              <p class="user-role" id="userDisplayRole">{{ user.department }}</p>
            </div>
          </div>

          <nav class="menu">
            <ul>
              <li
                class="menu-item {% if request.url.path == '/dashboard' %}active{% endif %}"
              >
                <a href="/dashboard">
                  <i class="fa-solid fa-chart-line"></i>
                  <span>TMS</span>
                </a>
              </li>
              <li
                class="menu-item {% if request.url.path == '/handover' %}active{% endif %}"
              >
                <a href="/handover">
                  <i class="fa-solid fa-right-left"></i>
                  <span>Work-Notice</span>
                </a>
              </li>
              {% if user and user.user_role == 'ADMIN' %}
              <li
                class="menu-item {% if request.url.path == '/users' %}active{% endif %}"
              >
                <a href="/users">
                  <i class="fa-solid fa-users"></i>
                  <span>사용자 관리</span>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>

          <div class="logout-container">
            <button id="logoutBtn" class="logout-btn">
              <i class="fa-solid fa-right-from-bracket"></i>
              <span>로그아웃</span>
            </button>
          </div>

          <!-- 사이드바 하단 로고 -->
          <div class="sidebar-footer">
            <img
              src="{{ url_for('static', path='images/logo.png') }}"
              alt="Teckwah 로고"
              class="footer-logo"
            />
          </div>
        </aside>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
          <!-- 컨텐츠 영역 -->
          <div class="content-container">
            <!-- 페이지별 컨텐츠 -->
            {% block content %}{% endblock %}
          </div>
        </main>
      </div>
    </div>

    <!-- 알림 메시지 컴포넌트 -->
    <div class="message-popup" id="messagePopup">
      <div class="message-content">
        <i class="fa-solid message-icon"></i>
        <span class="message-text"></span>
      </div>
    </div>

    <!-- 세션 만료 대화상자 -->
    <div id="sessionExpiredDialog" class="dialog">
      <div class="dialog-content">
        <h3>세션 만료 알림</h3>
        <p>로그인 세션이 만료되었습니다. 다시 로그인해야 계속 사용할 수 있습니다.</p>
        <div class="dialog-actions">
          <button id="sessionLoginBtn" class="btn primary-btn">로그인 페이지로 이동</button>
        </div>
      </div>
    </div>

    <!-- 공통 JavaScript -->
    <script src="{{ url_for('static', path='js/utils.js') }}"></script>
    <script src="{{ url_for('static', path='js/auth.js') }}"></script>

    <!-- 페이지별 JavaScript -->
    {% block page_js %}{% endblock %}
    
    <!-- 사용자 정보 초기화 스크립트 -->
    <script>
      // 서버에서 전달된 사용자 정보를 클라이언트에 저장
      document.addEventListener('DOMContentLoaded', function() {
        // 사용자 정보가 서버에서 제공된 경우만 저장
        {% if user %}
        if (Utils && Utils.auth) {
          const userData = {
            user_id: "{{ user.user_id }}",
            user_name: "{{ user.user_name }}",
            user_role: "{{ user.user_role }}",
            department: "{{ user.department }}"
          };
          Utils.auth.setCurrentUser(userData);
        }
        {% endif %}
        
        // 로그아웃 버튼 이벤트 핸들러
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            if (confirm('로그아웃 하시겠습니까?')) {
              if (Utils && Utils.auth) {
                Utils.auth.logout();
              } else {
                window.location.href = '/logout';
              }
            }
          });
        }
        
        // 세션 만료 대화상자 버튼 이벤트
        const sessionLoginBtn = document.getElementById('sessionLoginBtn');
        if (sessionLoginBtn) {
          sessionLoginBtn.addEventListener('click', function() {
            window.location.href = '/login?return_to=' + encodeURIComponent(window.location.pathname);
          });
        }
      });
    </script>
  </body>
</html>
