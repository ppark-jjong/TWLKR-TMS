{% extends "base.html" %}

{% block title %}주문 수정 - Teckwah TMS{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/orders.css') }}">
{% endblock %}

{% block content %}
<div class="order-form-page">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fa-solid fa-edit"></i>
            주문 정보 수정
        </h1>
        <div class="header-actions">
            <a href="/orders/{{ order.dashboardId }}" class="btn secondary-btn">
                <i class="fa-solid fa-times"></i>
                취소
            </a>
        </div>
    </div>

    {% if not order.editable %}
    <div class="alert alert-warning">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <div class="alert-content">
            <strong>주의:</strong> 이 주문은 현재 다른 사용자({{ order.updatedBy }})가 수정 중입니다.
            <br>락이 해제될 때까지 기다려주세요.
        </div>
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-error">
        <i class="fa-solid fa-exclamation-circle"></i>
        <div class="alert-content">
            <strong>오류:</strong> {{ error }}
        </div>
    </div>
    {% endif %}
    
    <div class="main-card">
        <form id="editOrderForm" action="/api/orders/{{ order.dashboardId }}" method="POST" class="order-form">
            <input type="hidden" name="_method" value="PUT">
            <input type="hidden" name="dashboard_id" value="{{ order.dashboardId }}">
            
            <div class="form-section">
                <h3 class="section-title">기본 정보</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="order_no">주문번호</label>
                        <input type="text" id="order_no" name="order_no" class="input-field" value="{{ order.orderNo }}" readonly>
                        <small class="help-text">주문번호는 변경할 수 없습니다.</small>
                    </div>
                    <div class="form-group">
                        <label for="type">유형 <span class="required">*</span></label>
                        <select id="type" name="type" class="select-field" required {% if not order.editable %}disabled{% endif %}>
                            <option value="DELIVERY" {% if order.type == 'DELIVERY' %}selected{% endif %}>배송</option>
                            <option value="RETURN" {% if order.type == 'RETURN' %}selected{% endif %}>회수</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="department">부서 <span class="required">*</span></label>
                        <select id="department" name="department" class="select-field" required {% if not order.editable %}disabled{% endif %}>
                            <option value="CS" {% if order.department == 'CS' %}selected{% endif %}>CS</option>
                            <option value="HES" {% if order.department == 'HES' %}selected{% endif %}>HES</option>
                            <option value="LENOVO" {% if order.department == 'LENOVO' %}selected{% endif %}>LENOVO</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="warehouse">창고 <span class="required">*</span></label>
                        <select id="warehouse" name="warehouse" class="select-field" required {% if not order.editable %}disabled{% endif %}>
                            <option value="SEOUL" {% if order.warehouse == 'SEOUL' %}selected{% endif %}>서울</option>
                            <option value="BUSAN" {% if order.warehouse == 'BUSAN' %}selected{% endif %}>부산</option>
                            <option value="GWANGJU" {% if order.warehouse == 'GWANGJU' %}selected{% endif %}>광주</option>
                            <option value="DAEJEON" {% if order.warehouse == 'DAEJEON' %}selected{% endif %}>대전</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="sla">SLA <span class="required">*</span></label>
                        <input type="text" id="sla" name="sla" class="input-field" value="{{ order.sla }}" required {% if not order.editable %}disabled{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="eta">ETA <span class="required">*</span></label>
                        <input type="datetime-local" id="eta" name="eta" class="input-field" value="{{ order.eta|datetime('%Y-%m-%dT%H:%M') }}" required {% if not order.editable %}disabled{% endif %}>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">배송 정보</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="postal_code">우편번호 <span class="required">*</span></label>
                        <input type="text" id="postal_code" name="postal_code" class="input-field" value="{{ order.postalCode }}" maxlength="5" required {% if not order.editable %}disabled{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="customer">고객명 <span class="required">*</span></label>
                        <input type="text" id="customer" name="customer" class="input-field" value="{{ order.customer }}" required {% if not order.editable %}disabled{% endif %}>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">주소 <span class="required">*</span></label>
                    <input type="text" id="address" name="address" class="input-field" value="{{ order.address }}" required {% if not order.editable %}disabled{% endif %}>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="contact">연락처</label>
                        <input type="text" id="contact" name="contact" class="input-field" value="{{ order.contact }}" {% if not order.editable %}disabled{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="status">상태 <span class="required">*</span></label>
                        <select id="status" name="status" class="select-field" required {% if not order.editable %}disabled{% endif %}>
                            {% for option in status_options %}
                            <option value="{{ option.value }}" {% if option.selected %}selected{% endif %} {% if option.disabled %}disabled{% endif %}>
                                {{ option.label }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if user.user_role != 'ADMIN' %}
                        <small class="help-text">일반 사용자는 제한된 상태 변경만 가능합니다.</small>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">기사 정보</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="driver_name">기사명</label>
                        <input type="text" id="driver_name" name="driver_name" class="input-field" value="{{ order.driverName }}" {% if not order.editable %}disabled{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="driver_contact">기사 연락처</label>
                        <input type="text" id="driver_contact" name="driver_contact" class="input-field" value="{{ order.driverContact }}" {% if not order.editable %}disabled{% endif %}>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">추가 정보</h3>
                
                <div class="form-group">
                    <label for="remark">메모</label>
                    <textarea id="remark" name="remark" class="text-area" rows="3" {% if not order.editable %}disabled{% endif %}>{{ order.remark }}</textarea>
                </div>
            </div>

            <!-- 업데이트 정보 -->
            <div class="update-info-section">
                <div class="update-info">
                    <div class="update-item">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                        <span class="update-label">최근 업데이트:</span>
                        <span class="update-value">{{ order.updateAt|datetime }}</span>
                    </div>
                    <div class="update-item">
                        <i class="fa-solid fa-user-edit"></i>
                        <span class="update-label">수정자:</span>
                        <span class="update-value">{{ order.updatedBy }}</span>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <a href="/orders/{{ order.dashboardId }}" class="btn secondary-btn">취소</a>
                <button type="submit" class="btn primary-btn" {% if not order.editable %}disabled{% endif %}>
                    <i class="fa-solid fa-check"></i> 저장
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 우편번호 자동 보완
    const postalCodeInput = document.getElementById('postal_code');
    if (postalCodeInput) {
        postalCodeInput.addEventListener('blur', function() {
            // 4자리 우편번호 입력 시 5자리로 자동 보완
            const value = this.value.trim();
            if (value.length === 4 && /^\d{4}$/.test(value)) {
                this.value = '0' + value;
            }
        });
    }
    
    // 폼 제출 이벤트
    const orderForm = document.getElementById('editOrderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 폼 데이터 수집
            const formData = new FormData(orderForm);
            const jsonData = {};
            
            for (const [key, value] of formData.entries()) {
                // _method와 dashboard_id는 제외
                if (key !== '_method' && key !== 'dashboard_id') {
                    jsonData[key] = value;
                }
            }
            
            try {
                // 로딩 상태 표시
                const submitBtn = orderForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 저장 중...';
                
                // API 요청
                const response = await fetch(`/api/orders/${formData.get('dashboard_id')}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                });
                
                // 응답 처리
                const result = await response.json();
                
                if (result.success) {
                    // 성공 시 상세 페이지로 이동
                    window.location.href = `/orders/${formData.get('dashboard_id')}?success=주문이 성공적으로 수정되었습니다`;
                } else {
                    // 실패 시 에러 메시지 표시
                    Utils.message.error(result.message || '주문 수정에 실패했습니다.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fa-solid fa-check"></i> 저장';
                }
            } catch (error) {
                console.error('주문 수정 중 오류:', error);
                Utils.message.error('주문 수정 중 오류가 발생했습니다.');
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-check"></i> 저장';
            }
        });
    }
});
</script>
{% endblock %}
