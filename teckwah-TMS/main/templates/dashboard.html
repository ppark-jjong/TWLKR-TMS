{% extends "base.html" %}

{% block title %}대시보드 - Teckwah TMS{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-page">
    <!-- 로딩 오버레이 추가 (기본적으로 활성화) -->
    <div class="loading-overlay active" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>데이터를 불러오는 중입니다...</p>
        </div>
    </div>
    
    <div class="main-card">
        <!-- 페이지 제목 -->
        <div class="page-header">
            <h2 class="page-title">대시보드</h2>
            <p class="page-subtitle">배송 주문 조회 및 관리</p>
        </div>
        
        <!-- 필터 헤더 영역 (Form 제출 방식으로 변경) -->
        <div class="filter-header">
            <form action="/dashboard" method="GET" class="date-filter-form">
                <div class="date-filter-container">
                    <div class="date-input-group">
                        <input type="date" id="startDate" name="start_date" class="date-input" value="{{ initial_data.today }}">
                        <span class="date-separator">~</span>
                        <input type="date" id="endDate" name="end_date" class="date-input" value="{{ initial_data.today }}">
                    </div>
                    <button type="submit" class="btn primary-btn" id="searchDateBtn">
                        <i class="fa-solid fa-search"></i> 조회
                    </button>
                    <a href="/dashboard" class="btn secondary-btn" id="todayBtn">
                        <i class="fa-solid fa-calendar-day"></i> 오늘
                    </a>
                    
                    <div class="page-size-selector">
                        <span>표시 행 수:</span>
                        <select id="pageSize" name="page_size" class="select-field">
                            <option value="10" {% if initial_data.pagination.page_size == 10 %}selected{% endif %}>10행</option>
                            <option value="30" {% if initial_data.pagination.page_size == 30 %}selected{% endif %}>30행</option>
                            <option value="50" {% if initial_data.pagination.page_size == 50 %}selected{% endif %}>50행</option>
                        </select>
                    </div>
                </div>
            </form>

            <form action="/dashboard" method="GET" class="search-form">
                <div class="search-container">
                    <input type="text" id="searchOrderNo" name="order_no" class="search-input" placeholder="주문번호 검색">
                    <button type="submit" class="btn search-button" id="searchOrderBtn">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- 필터 영역 -->
        <div class="filter-box">
            <div class="filter-controls">
                <div class="filter-item">
                    <label for="statusFilter">상태</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="">전체</option>
                        <option value="WAITING">대기</option>
                        <option value="IN_PROGRESS">진행</option>
                        <option value="COMPLETE">완료</option>
                        <option value="ISSUE">이슈</option>
                        <option value="CANCEL">취소</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="departmentFilter">부서</label>
                    <select id="departmentFilter" class="filter-select">
                        <option value="">전체</option>
                        <option value="CS">CS</option>
                        <option value="HES">HES</option>
                        <option value="LENOVO">LENOVO</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="warehouseFilter">창고</label>
                    <select id="warehouseFilter" class="filter-select">
                        <option value="">전체</option>
                        <option value="SEOUL">서울</option>
                        <option value="BUSAN">부산</option>
                        <option value="GWANGJU">광주</option>
                        <option value="DAEJEON">대전</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn primary-btn" id="applyFilterBtn">
                    <i class="fa-solid fa-filter"></i> 필터 적용
                </button>
                <button class="btn secondary-btn" id="resetFilterBtn">
                    <i class="fa-solid fa-rotate-left"></i> 초기화
                </button>
            </div>
        </div>

        <!-- 액션 버튼 -->
        <div class="action-buttons">
            <button class="btn secondary-btn" id="customizeColumnsBtn">
                <i class="fa-solid fa-table-columns"></i> 컬럼 설정
            </button>
            <button class="btn primary-btn" id="refreshBtn">
                <i class="fa-solid fa-arrows-rotate"></i> 새로고침
            </button>
            <a href="/orders/create" class="btn primary-btn">
                <i class="fa-solid fa-plus"></i> 신규 등록
            </a>
        </div>

        <!-- 컬럼 커스터마이징 대화상자 (필요한 컬럼만 포함) -->
        <div id="columnDialog" class="dialog">
            <div class="dialog-content">
                <h3>테이블 컬럼 설정</h3>
                <p>표시할 컬럼을 선택하세요:</p>
                
                <div class="columns-grid" id="columnSettingsGrid">
                    <!-- 기본 컬럼 (항상 표시) -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_order_no" name="columns" value="order_no" checked disabled>
                        <label for="col_order_no">주문번호 (필수)</label>
                    </div>
                    
                    <!-- 선택 가능한 컬럼들 -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_customer" name="columns" value="customer" checked>
                        <label for="col_customer">고객</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_type" name="columns" value="type" checked>
                        <label for="col_type">유형</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_status" name="columns" value="status" checked>
                        <label for="col_status">상태</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_department" name="columns" value="department" checked>
                        <label for="col_department">부서</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_warehouse" name="columns" value="warehouse" checked>
                        <label for="col_warehouse">창고</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_eta" name="columns" value="eta" checked>
                        <label for="col_eta">ETA</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_region" name="columns" value="region" checked>
                        <label for="col_region">지역</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_driver" name="columns" value="driver" checked>
                        <label for="col_driver">기사명</label>
                    </div>
                </div>
                
                <div class="dialog-actions">
                    <button type="button" class="btn secondary-btn" id="cancelColumnsBtn">취소</button>
                    <button type="button" class="btn primary-btn" id="applyColumnsBtn">적용</button>
                </div>
            </div>
        </div>

        <!-- 락 상태 대화상자는 상세 페이지에서만 사용하므로 목록 페이지에서 제거 -->

                <!-- 통계 카드 영역 제거 -->

        <!-- 데이터 테이블 (최적화 버전) -->
        <div class="table-container">
            <table class="data-table" id="dashboardTable">
                <thead>
                    <tr>
                        <th width="15%">주문번호</th>
                        <th width="15%">고객</th>
                        <th width="8%">유형</th>
                        <th width="10%">상태</th>
                        <th width="10%">부서</th>
                        <th width="10%">창고</th>
                        <th width="15%">ETA</th>
                        <th width="10%">지역</th>
                        <th width="12%">배송기사</th>
                    </tr>
                </thead>
                <tbody id="dashboardTableBody">
                    {% if initial_data.orders %}
                        {% for order in initial_data.orders %}
                        <tr class="status-{{ order.status|lower }} clickable-row" data-id="{{ order.dashboardId }}">
                            <td>
                                <a href="/orders/{{ order.dashboardId }}" class="order-number">{{ order.orderNo }}</a>
                            </td>
                            <td class="truncate">{{ order.customer }}</td>
                            <td>{{ order.typeLabel }}</td>
                            <td>
                                <span class="status-badge status-{{ order.status|lower }}">{{ order.statusLabel }}</span>
                            </td>
                            <td>{{ order.department }}</td>
                            <td>{{ order.warehouse }}</td>
                            <td>{{ order.eta }}</td>
                            <td>{{ order.region }}</td>
                            <td class="truncate">{{ order.driverName }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <!-- 데이터 없음 표시 행 -->
                        <tr class="empty-data-row">
                            <td colspan="9" class="empty-table">
                                <div class="empty-placeholder">
                                    <i class="fa-solid fa-inbox"></i>
                                    <p>조건에 맞는 주문이 없습니다</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination" id="pagination">
            <button class="page-btn" data-page="prev" {% if initial_data.pagination.current <= 1 %}disabled{% endif %}>
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <span class="page-info" id="pageInfo">{{ initial_data.pagination.current }} / {{ initial_data.pagination.total_pages }}</span>
            <button class="page-btn" data-page="next" {% if initial_data.pagination.current >= initial_data.pagination.total_pages %}disabled{% endif %}>
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <!-- 오류 메시지 표시 영역 추가 -->
        {% if initial_data.error_message %}
        <div class="error-message-container">
            <div class="alert alert-danger">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ initial_data.error_message }}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block page_js %}
<!-- 초기 데이터를 페이지에 데이터 속성으로 추가 -->
<div id="dashboardDataContainer" 
     data-initial="{{ initial_data|tojson }}" 
     class="hidden"></div>

<!-- 로그 디버그 정보 (개발 모드에서만 표시) -->
<div id="logContainer" class="log-container" style="display: none;">
  <div class="log-header">
    <h3>디버그 로그</h3>
    <button id="toggleLogBtn" class="btn secondary-btn">닫기</button>
  </div>
  <div id="logContent" class="log-content"></div>
</div>

<script>
  // 디버그 모드 확인 (개발 환경에서만 사용)
  const isDebugMode = true;
  
  if (isDebugMode) {
    // 콘솔 로그 오버라이드하여 로그 컨테이너에 표시
    const logContainer = document.getElementById('logContainer');
    const logContent = document.getElementById('logContent');
    const toggleLogBtn = document.getElementById('toggleLogBtn');
    
    // 로그 컨테이너 표시
    logContainer.style.display = 'block';
    
    // 토글 버튼 이벤트
    toggleLogBtn.addEventListener('click', function() {
      if (logContent.style.display === 'none') {
        logContent.style.display = 'block';
        toggleLogBtn.textContent = '닫기';
      } else {
        logContent.style.display = 'none';
        toggleLogBtn.textContent = '열기';
      }
    });
    
    // 로그 추가 함수
    function addLogMessage(level, message) {
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${level.toLowerCase()}`;
      
      const timestamp = new Date().toISOString().slice(11, 19);
      logItem.innerHTML = `<span class="log-time">${timestamp}</span> <span class="log-level">${level}</span> ${message}`;
      
      logContent.appendChild(logItem);
      logContent.scrollTop = logContent.scrollHeight;
    }
    
    // 원본 콘솔 메서드 저장
    const originalConsole = {
      log: console.log,
      warn: console.warn,
      error: console.error,
      info: console.info,
      debug: console.debug
    };
    
    // 콘솔 로그 오버라이드
    console.log = function() {
      originalConsole.log.apply(console, arguments);
      
      const message = Array.from(arguments).map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg) : arg
      ).join(' ');
      
      // 로거 메시지 형식 확인 및 처리
      if (message.startsWith('로거:')) {
        const parts = message.split(' ');
        const level = parts[1];
        const logMessage = parts.slice(2).join(' ');
        addLogMessage(level, logMessage);
      } else {
        // 일반 콘솔 로그
        addLogMessage('LOG', message);
      }
    };
    
    console.error = function() {
      originalConsole.error.apply(console, arguments);
      
      const message = Array.from(arguments).map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg) : arg
      ).join(' ');
      
      if (message.startsWith('로거:') && message.includes('ERROR')) {
        const logMessage = message.split('로거: ERROR ')[1];
        addLogMessage('ERROR', logMessage);
      } else {
        addLogMessage('ERROR', message);
      }
    };
    
    console.warn = function() {
      originalConsole.warn.apply(console, arguments);
      
      const message = Array.from(arguments).map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg) : arg
      ).join(' ');
      
      if (message.startsWith('로거:') && message.includes('WARN')) {
        const logMessage = message.split('로거: WARN ')[1];
        addLogMessage('WARN', logMessage);
      } else {
        addLogMessage('WARN', message);
      }
    };
  }
</script>

<script src="{{ url_for('static', path='js/dashboard.js') }}"></script>
{% endblock %}
