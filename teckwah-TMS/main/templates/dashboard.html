{% extends "base.html" %} {% block title %}대시보드 - Teckwah TMS{% endblock %}
{% block page_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', path='css/dashboard.css') }}"
/>
{% endblock %} {% block content %}
<div class="dashboard-page">
  <!-- 로딩 오버레이 추가 (기본적으로 활성화) -->
  <div class="loading-overlay active" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>데이터를 불러오는 중입니다...</p>
    </div>
  </div>

  <div class="main-card">
    <!-- 페이지 제목 -->
    <div class="page-header">
      <h2 class="page-title">대시보드</h2>
      <p class="page-subtitle">배송 주문 조회 및 관리</p>
    </div>

    <!-- 필터 헤더 영역 (Form 제출 방식으로 변경) -->
    <div class="filter-header">
      <form action="/dashboard" method="GET" class="date-filter-form">
        <div class="date-filter-container">
          <div class="user-info-badge">
            <i class="fa-solid fa-user-tag"></i>
            <span>{{ user.user_id }} ({{ user.user_role }})</span>
          </div>

          <div class="date-input-group">
            <input
              type="date"
              id="startDate"
              name="start_date"
              class="date-input"
              value="{{ initial_data.today}}"
              min="{{ initial_data.today }}"
              max="{{ initial_data.today }}"
              required
            />

            <div class="filter-box">
              <div class="filter-controls">
                <div class="filter-item">
                  <label for="statusFilter">상태</label>
                  <select id="statusFilter" class="filter-select">
                    <option value="">전체</option>
                    <option value="WAITING">대기</option>
                    <option value="IN_PROGRESS">진행</option>
                    <option value="COMPLETE">완료</option>
                    <option value="ISSUE">이슈</option>
                    <option value="CANCEL">취소</option>
                  </select>
                </div>

                <div class="filter-item">
                  <label for="departmentFilter">부서</label>
                  <select id="departmentFilter" class="filter-select">
                    <option value="">전체</option>
                    <option value="CS">CS</option>
                    <option value="HES">HES</option>
                    <option value="LENOVO">LENOVO</option>
                  </select>
                </div>

                <div class="filter-item">
                  <label for="warehouseFilter">창고</label>
                  <select id="warehouseFilter" class="filter-select">
                    <option value="">전체</option>
                    <option value="SEOUL">서울</option>
                    <option value="BUSAN">부산</option>
                    <option value="GWANGJU">광주</option>
                    <option value="DAEJEON">대전</option>
                  </select>
                </div>
              </div>

              <div class="filter-actions">
                <button class="btn primary-btn" id="applyFilterBtn">
                  <i class="fa-solid fa-filter"></i> 필터 적용
                </button>
                <button class="btn secondary-btn" id="resetFilterBtn">
                  <i class="fa-solid fa-rotate-left"></i> 초기화
                </button>
              </div>
            </div>

            <!-- 액션 버튼 -->
            <div class="action-buttons">
              <button class="btn secondary-btn" id="customizeColumnsBtn">
                <i class="fa-solid fa-table-columns"></i> 컬럼 설정
              </button>
              <button class="btn primary-btn" id="refreshBtn">
                <i class="fa-solid fa-arrows-rotate"></i> 새로고침
              </button>
              <a href="/orders/new" class="btn primary-btn">
                <i class="fa-solid fa-plus"></i> 신규 등록
              </a>
            </div>

            <!-- 컬럼 커스터마이징 대화상자 (필요한 컬럼만 포함) -->
            <div id="columnDialog" class="dialog">
              <div class="dialog-content">
                <h3>테이블 컬럼 설정</h3>
                <p>표시할 컬럼을 선택하세요:</p>

                <div class="columns-grid" id="columnSettingsGrid">
                  <!-- 기본 컬럼 (항상 표시) -->
                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_order_no"
                      name="columns"
                      value="order_no"
                      checked
                      disabled
                    />
                    <label for="col_order_no">주문번호 (필수)</label>
                  </div>

                  <!-- 선택 가능한 컬럼들 -->
                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_customer"
                      name="columns"
                      value="customer"
                      checked
                    />
                    <label for="col_customer">고객</label>
                  </div>

                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_type"
                      name="columns"
                      value="type"
                      checked
                    />
                    <label for="col_type">유형</label>
                  </div>

                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_status"
                      name="columns"
                      value="status"
                      checked
                    />
                    <label for="col_status">상태</label>
                  </div>

                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_department"
                      name="columns"
                      value="department"
                      checked
                    />
                    <label for="col_department">부서</label>
                  </div>

                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_warehouse"
                      name="columns"
                      value="warehouse"
                      checked
                    />
                    <label for="col_warehouse">창고</label>
                  </div>

                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_eta"
                      name="columns"
                      value="eta"
                      checked
                    />
                    <label for="col_eta">ETA</label>
                  </div>

                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_region"
                      name="columns"
                      value="region"
                      checked
                    />
                    <label for="col_region">지역</label>
                  </div>

                  <div class="checkbox-container">
                    <input
                      type="checkbox"
                      id="col_driver"
                      name="columns"
                      value="driver"
                      checked
                    />
                    <label for="col_driver">기사명</label>
                  </div>
                </div>

                <div class="dialog-actions">
                  <button
                    type="button"
                    class="btn secondary-btn"
                    id="cancelColumnsBtn"
                  >
                    취소
                  </button>
                  <button
                    type="button"
                    class="btn primary-btn"
                    id="applyColumnsBtn"
                  >
                    적용
                  </button>
                </div>
              </div>
            </div>

            <!-- 락 상태 대화상자는 상세 페이지에서만 사용하므로 목록 페이지에서 제거 -->

            <!-- 통계 카드 영역 제거 -->

            <!-- 데이터 테이블 (최적화 버전) -->
            <div class="table-container">
              <table class="data-table" id="dashboardTable">
                <thead>
                  <tr>
                    <th width="15%">주문번호</th>
                    <th width="15%">고객</th>
                    <th width="8%">유형</th>
                    <th width="10%">상태</th>
                    <th width="10%">부서</th>
                    <th width="10%">창고</th>
                    <th width="15%">ETA</th>
                    <th width="10%">지역</th>
                    <th width="12%">배송기사</th>
                  </tr>
                </thead>
                <tbody id="dashboardTableBody">
                  {% if initial_data.orders %} {% for order in
                  initial_data.orders %}
                  <tr
                    class="status-{{ order.status|lower }} clickable-row"
                    data-id="{{ order.dashboardId }}"
                  >
                    <td>
                      <a
                        href="/orders/{{ order.dashboardId }}"
                        class="order-number"
                        >{{ order.orderNo }}</a
                      >
                    </td>
                    <td class="truncate">{{ order.customer }}</td>
                    <td>{{ order.typeLabel }}</td>
                    <td>
                      <span class="status-badge status-{{ order.status|lower }}"
                        >{{ order.statusLabel }}</span
                      >
                    </td>
                    <td>{{ order.department }}</td>
                    <td>{{ order.warehouse }}</td>
                    <td>{{ order.eta }}</td>
                    <td>{{ order.region }}</td>
                    <td class="truncate">{{ order.driverName }}</td>
                  </tr>
                  {% endfor %} {% else %}
                  <!-- 데이터 없음 표시 행 -->
                  <tr class="empty-data-row">
                    <td colspan="9" class="empty-table">
                      <div class="empty-placeholder">
                        <i class="fa-solid fa-inbox"></i>
                        <p>조건에 맞는 주문이 없습니다</p>
                      </div>
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <!-- 페이지네이션 -->
            <div class="pagination" id="pagination">
              <button
                class="page-btn"
                data-page="prev"
                {% if initial_data.pagination.current|int <= 1 %}disabled{% endif %}
              >
                <i class="fa-solid fa-chevron-left"></i>
              </button>
              <span class="page-info" id="pageInfo"
                >{{ initial_data.pagination.current }} / {{
                initial_data.pagination.total_pages }}</span
              >
              <button class="pagination-next" {% if initial_data.pagination.current|int >= initial_data.pagination.total_pages|int %}disabled{% endif %}>
                <i class="fa-solid fa-chevron-right"></i>
              </button>
            </div>

            <!-- 오류 메시지 표시 영역 추가 -->
            {% if initial_data.error_message %}
            <div class="error-message-container">
              <div class="alert alert-danger">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ initial_data.error_message }}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
<!-- 초기 데이터를 페이지에 데이터 속성으로 추가 -->
<div
  id="dashboardDataContainer"
  data-initial='{{ initial_data|tojson|safe }}'
  class="hidden"
></div>

<script src="{{ url_for('static', path='js/dashboard.js') }}"></script>
{% endblock %}
