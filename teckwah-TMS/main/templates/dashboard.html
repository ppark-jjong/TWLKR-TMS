{% extends "base.html" %} {% block title %}대시보드 - Teckwah TMS{% endblock %}
{% block page_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', path='css/dashboard.css') }}"
/>
{% endblock %} {% block content %}
<div class="dashboard-page">
  <!-- 로딩 오버레이 추가 (기본적으로 활성화) -->
  <div class="loading-overlay active" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>데이터를 불러오는 중입니다...</p>
    </div>
  </div>

  <div class="main-card">
    <!-- 페이지 제목 -->
    <div class="page-header">
      <h2 class="page-title">대시보드</h2>
    </div>

    <!-- 필터 헤더 영역 -->
    <div class="filter-bar">
      <!-- 날짜 범위 및 검색 영역 -->
      <div class="top-filter-row">
        <!-- 날짜 범위 선택 -->
        <div class="date-range-filter">
          <div class="filter-item">
            <label for="startDate">시작일</label>
            <input
              type="date"
              id="startDate"
              class="date-input"
              value="{{ initial_data.today}}"
            />
          </div>
          <span class="date-separator">~</span>
          <div class="filter-item">
            <label for="endDate">종료일</label>
            <input
              type="date"
              id="endDate"
              class="date-input"
              value="{{ initial_data.end_date}}"
            />
          </div>
          <button type="button" id="dateSearchBtn" class="btn primary-btn date-search-btn">
            <i class="fa-solid fa-search"></i> 조회
          </button>
        </div>

        <!-- 주문번호 검색 -->
        <div class="search-container">
          <div class="search-box">
            <input 
              type="text" 
              id="orderNoSearch"
              class="search-input" 
              placeholder="주문번호 검색" 
              value="{{ initial_data.order_no }}"
            />
            <button type="button" id="orderSearchBtn" class="search-btn">
              <i class="fa-solid fa-search"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- 필터링 요소들 -->
      <div class="filter-controls">
        <div class="filter-item">
          <label for="statusFilter">상태</label>
          <select id="statusFilter" class="filter-select">
            <option value="">전체</option>
            <option value="WAITING">대기</option>
            <option value="IN_PROGRESS">진행</option>
            <option value="COMPLETE">완료</option>
            <option value="ISSUE">이슈</option>
            <option value="CANCEL">취소</option>
          </select>
        </div>

        <div class="filter-item">
          <label for="departmentFilter">부서</label>
          <select id="departmentFilter" class="filter-select">
            <option value="">전체</option>
            <option value="CS">CS</option>
            <option value="HES">HES</option>
            <option value="LENOVO">LENOVO</option>
          </select>
        </div>

        <div class="filter-item">
          <label for="warehouseFilter">창고</label>
          <select id="warehouseFilter" class="filter-select">
            <option value="">전체</option>
            <option value="SEOUL">서울</option>
            <option value="BUSAN">부산</option>
            <option value="GWANGJU">광주</option>
            <option value="DAEJEON">대전</option>
          </select>
        </div>

        <button class="btn secondary-btn" id="applyFilterBtn">
          <i class="fa-solid fa-filter"></i> 필터 적용
        </button>
        <button class="btn secondary-btn" id="resetFilterBtn">
          <i class="fa-solid fa-rotate-left"></i> 초기화
        </button>
      </div>
      
      <!-- 액션 버튼 영역 -->
      <div class="actions-row">
        <div class="left-actions">
          <button class="btn secondary-btn" id="customizeColumnsBtn">
            <i class="fa-solid fa-table-columns"></i> 컬럼 설정
          </button>
        </div>
        <div class="right-actions">
          <button class="btn secondary-btn" id="refreshBtn">
            <i class="fa-solid fa-arrows-rotate"></i> 새로고침
          </button>
          <a href="/orders/new" class="btn primary-btn">
            <i class="fa-solid fa-plus"></i> 신규 등록
          </a>
        </div>
      </div>
    </div>

    <!-- 컬럼 커스터마이징 대화상자 -->
    <div id="columnDialog" class="dialog">
      <div class="dialog-content">
        <h3>테이블 컬럼 설정</h3>
        <p>표시할 컬럼을 선택하세요:</p>

        <div class="columns-grid" id="columnSettingsGrid">
          <!-- 기본 컬럼 (항상 표시) -->
          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_order_no"
              name="columns"
              value="order_no"
              checked
              disabled
            />
            <label for="col_order_no">주문번호 (필수)</label>
          </div>

          <!-- 선택 가능한 컬럼들 - DashboardListItem 스키마 순서로 변경 -->
          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_type"
              name="columns"
              value="type"
              checked
            />
            <label for="col_type">유형</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_department"
              name="columns"
              value="department"
              checked
            />
            <label for="col_department">부서</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_warehouse"
              name="columns"
              value="warehouse"
              checked
            />
            <label for="col_warehouse">창고</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_sla"
              name="columns"
              value="sla"
              checked
            />
            <label for="col_sla">SLA</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_region"
              name="columns"
              value="region"
              checked
            />
            <label for="col_region">지역</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_eta"
              name="columns"
              value="eta"
              checked
            />
            <label for="col_eta">ETA</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_customer"
              name="columns"
              value="customer"
              checked
            />
            <label for="col_customer">고객</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_status"
              name="columns"
              value="status"
              checked
            />
            <label for="col_status">상태</label>
          </div>

          <div class="checkbox-container">
            <input
              type="checkbox"
              id="col_driver"
              name="columns"
              value="driver"
              checked
            />
            <label for="col_driver">기사명</label>
          </div>
        </div>

        <div class="dialog-actions">
          <button
            type="button"
            class="btn secondary-btn"
            id="cancelColumnsBtn"
          >
            취소
          </button>
          <button
            type="button"
            class="btn primary-btn"
            id="applyColumnsBtn"
          >
            적용
          </button>
        </div>
      </div>
    </div>

    <!-- 데이터 테이블 -->
    <div class="table-scroll-container">
      <div class="table-container">
        <table class="data-table" id="dashboardTable">
          <thead>
            <tr>
              <th width="15%">주문번호</th>
              <th width="8%">유형</th>
              <th width="10%">부서</th>
              <th width="10%">창고</th>
              <th width="8%">SLA</th>
              <th width="10%">지역</th>
              <th width="15%">ETA</th>
              <th width="15%">고객</th>
              <th width="10%">상태</th>
              <th width="12%">배송기사</th>
            </tr>
          </thead>
          <tbody id="dashboardTableBody">
            {% if initial_data.orders %} {% for order in
            initial_data.orders %}
            <tr
              class="status-{{ order.status|lower }} clickable-row"
              data-id="{{ order.dashboardId }}"
              data-order="{{ order|tojson|safe }}"
            >
              <td>
                <a
                  href="/orders/{{ order.dashboardId }}"
                  class="order-number"
                  >{{ order.orderNo }}</a
                >
              </td>
              <td>{{ order.typeLabel }}</td>
              <td>{{ order.department }}</td>
              <td>{{ order.warehouse }}</td>
              <td>{{ order.sla }}</td>
              <td>{{ order.region }}</td>
              <td>{{ order.eta }}</td>
              <td>{{ order.customer }}</td>
              <td>
                <span class="status-badge status-{{ order.status|lower }}"
                  >{{ order.statusLabel }}</span
                >
              </td>
              <td>{{ order.driverName }}</td>
            </tr>
            {% endfor %} {% else %}
            <!-- 데이터 없음 표시 행 -->
            <tr class="empty-data-row">
              <td colspan="10" class="empty-table">
                <div class="empty-placeholder">
                  <i class="fa-solid fa-inbox"></i>
                  <p>조건에 맞는 주문이 없습니다</p>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- 페이지네이션 -->
    <div class="pagination-container">
      <div class="pagination" id="pagination">
        <button
          class="page-btn"
          data-page="prev"
          {% if initial_data.pagination.current|int <= 1 %}disabled{% endif %}
        >
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <span class="page-info" id="pageInfo"
          >{{ initial_data.pagination.current }} / {{
          initial_data.pagination.total_pages }}</span
        >
        <button 
          class="page-btn" 
          data-page="next"
          {% if initial_data.pagination.current|int >= initial_data.pagination.total_pages|int %}disabled{% endif %}
        >
          <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- 오류 메시지 표시 영역 추가 -->
    {% if initial_data.error_message %}
    <div class="error-message-container">
      <div class="alert alert-danger">
        <i class="fa-solid fa-circle-exclamation"></i>
        {{ initial_data.error_message }}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block page_js %}
<!-- 초기 데이터를 페이지에 데이터 속성으로 추가 -->
<div
  id="dashboardDataContainer"
  data-initial='{{ initial_data|tojson|safe }}'
  class="hidden"
></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const dateSearchBtn = document.getElementById('dateSearchBtn');
    const orderNoInput = document.getElementById('orderNoSearch');
    const orderSearchBtn = document.getElementById('orderSearchBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // 원본 데이터를 저장할 변수
    let originalData = [];
    
    // 초기 데이터 로드
    const initialData = JSON.parse(document.getElementById('dashboardDataContainer').getAttribute('data-initial'));
    if (initialData && initialData.orders) {
      originalData = initialData.orders;
    }
    
    // 로딩 오버레이 표시/숨김 함수
    function showLoading() {
      loadingOverlay.classList.add('active');
    }
    
    function hideLoading() {
      loadingOverlay.classList.remove('active');
    }
    
    // 테이블 업데이트 함수 - 필터링용
    function updateTableWithFilters() {
      const status = document.getElementById('statusFilter').value;
      const department = document.getElementById('departmentFilter').value;
      const warehouse = document.getElementById('warehouseFilter').value;
      
      const rows = document.querySelectorAll('#dashboardTableBody tr');
      let visibleCount = 0;
      
      rows.forEach(row => {
        if (row.classList.contains('empty-data-row')) return;
        
        const orderData = JSON.parse(row.getAttribute('data-order'));
        
        let shouldShow = true;
        
        // 상태 필터링
        if (status && orderData.status !== status) {
          shouldShow = false;
        }
        
        // 부서 필터링
        if (department && orderData.department !== department) {
          shouldShow = false;
        }
        
        // 창고 필터링
        if (warehouse && orderData.warehouse !== warehouse) {
          shouldShow = false;
        }
        
        // 행 표시 여부 설정
        if (shouldShow) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
      
      // 모든 행이 숨겨진 경우 '데이터 없음' 메시지 표시
      const emptyRow = document.querySelector('.empty-data-row');
      if (visibleCount === 0) {
        if (!emptyRow) {
          const tableBody = document.getElementById('dashboardTableBody');
          const newEmptyRow = document.createElement('tr');
          newEmptyRow.className = 'empty-data-row';
          newEmptyRow.innerHTML = `
            <td colspan="9" class="empty-table">
              <div class="empty-placeholder">
                <i class="fa-solid fa-inbox"></i>
                <p>조건에 맞는 주문이 없습니다</p>
              </div>
            </td>
          `;
          tableBody.appendChild(newEmptyRow);
        } else {
          emptyRow.style.display = '';
        }
      } else if (emptyRow) {
        emptyRow.style.display = 'none';
      }
    }
    
    // 날짜 검색 API 호출
    dateSearchBtn.addEventListener('click', function() {
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      
      // 날짜 검증
      if (new Date(endDate) < new Date(startDate)) {
        alert('종료일은 시작일보다 같거나 늦어야 합니다.');
        return;
      }
      
      showLoading();
      
      // 날짜 API 호출
      window.location.href = `/dashboard?start_date=${startDate}&end_date=${endDate}`;
    });
    
    // 주문번호 검색
    orderSearchBtn.addEventListener('click', function() {
      const orderNo = orderNoInput.value.trim();
      
      if (!orderNo) {
        alert('주문번호를 입력해주세요.');
        return;
      }
      
      showLoading();
      
      // 주문번호 검색 페이지로 이동
      window.location.href = `/dashboard/search?order_no=${encodeURIComponent(orderNo)}`;
    });
    
    // 주문번호 검색 엔터키 이벤트
    orderNoInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        orderSearchBtn.click();
      }
    });
    
    // 필터 적용 버튼 - 클라이언트 측 필터링
    document.getElementById('applyFilterBtn').addEventListener('click', function() {
      updateTableWithFilters();
    });
    
    // 필터 초기화 버튼
    document.getElementById('resetFilterBtn').addEventListener('click', function() {
      // 필터 초기화
      document.getElementById('statusFilter').value = '';
      document.getElementById('departmentFilter').value = '';
      document.getElementById('warehouseFilter').value = '';
      
      // 모든 행 표시
      const rows = document.querySelectorAll('#dashboardTableBody tr');
      rows.forEach(row => {
        if (!row.classList.contains('empty-data-row')) {
          row.style.display = '';
        }
      });
      
      // 데이터 없음 행 숨김
      const emptyRow = document.querySelector('.empty-data-row');
      if (emptyRow && document.querySelectorAll('#dashboardTableBody tr:not(.empty-data-row)').length > 0) {
        emptyRow.style.display = 'none';
      }
    });
    
    // 페이지네이션 버튼 이벤트
    document.querySelectorAll('.page-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        if (this.disabled) return;
        
        const direction = this.getAttribute('data-page');
        const currentPage = parseInt(document.getElementById('pageInfo').textContent.split(' / ')[0]);
        const newPage = direction === 'prev' ? currentPage - 1 : currentPage + 1;
        
        // 현재 URL에서 페이지 파라미터만 변경
        const url = new URL(window.location.href);
        url.searchParams.set('page', newPage);
        
        window.location.href = url.toString();
      });
    });
    
    // 새로고침 버튼
    document.getElementById('refreshBtn').addEventListener('click', function() {
      // 현재 URL 그대로 새로고침
      window.location.reload();
    });
    
    // 행 클릭 이벤트 추가
    document.querySelectorAll('.clickable-row').forEach(row => {
      row.addEventListener('click', function(e) {
        // 주문번호 링크를 클릭한 경우 무시 (링크는 그대로 동작)
        if (e.target.classList.contains('order-number') || e.target.closest('.order-number')) {
          return;
        }
        
        // 테이블 행의 주문ID로 상세 페이지 이동
        const id = this.getAttribute('data-id');
        window.location.href = `/orders/${id}`;
      });
    });
    
    // 컬럼 설정 버튼
    const customizeColumnsBtn = document.getElementById('customizeColumnsBtn');
    const columnDialog = document.getElementById('columnDialog');
    const cancelColumnsBtn = document.getElementById('cancelColumnsBtn');
    const applyColumnsBtn = document.getElementById('applyColumnsBtn');
    
    customizeColumnsBtn.addEventListener('click', function() {
      columnDialog.classList.add('active');
    });
    
    cancelColumnsBtn.addEventListener('click', function() {
      columnDialog.classList.remove('active');
    });
    
    applyColumnsBtn.addEventListener('click', function() {
      // 컬럼 표시 여부 설정
      const columns = document.querySelectorAll('[name="columns"]:checked');
      const columnIndexes = Array.from(columns).map(col => col.value);
      
      // 테이블 헤더와 모든 행에서 컬럼 표시/숨김 처리
      const table = document.getElementById('dashboardTable');
      const headers = table.querySelectorAll('thead th');
      const rows = table.querySelectorAll('tbody tr');
      
      headers.forEach((header, index) => {
        if (index === 0) return; // 주문번호 컬럼은 항상 표시
        
        const columnName = getColumnNameByIndex(index);
        if (columnIndexes.includes(columnName)) {
          header.style.display = '';
        } else {
          header.style.display = 'none';
        }
      });
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
          if (index === 0) return; // 주문번호 컬럼은 항상 표시
          
          const columnName = getColumnNameByIndex(index);
          if (columnIndexes.includes(columnName)) {
            cell.style.display = '';
          } else {
            cell.style.display = 'none';
          }
        });
      });
      
      columnDialog.classList.remove('active');
    });
    
    // 컬럼 인덱스에 따른 컬럼명 가져오기
    function getColumnNameByIndex(index) {
      const columnMap = {
        0: 'order_no',
        1: 'customer',
        2: 'type',
        3: 'status',
        4: 'department',
        5: 'warehouse',
        6: 'eta',
        7: 'region',
        8: 'driver'
      };
      return columnMap[index] || '';
    }
    
    // 페이지 로드 시 로딩 오버레이 숨김
    setTimeout(() => {
      hideLoading();
    }, 500);
  });
</script>
{% endblock %}