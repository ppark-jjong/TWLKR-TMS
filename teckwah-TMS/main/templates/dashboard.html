{% extends "base.html" %}

{% block title %}대시보드 - Teckwah TMS{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-page">
    <div class="main-card">
        <!-- 페이지 제목 -->
        <div class="page-header">
            <h2 class="page-title">대시보드</h2>
            <p class="page-subtitle">배송 주문 조회 및 관리</p>
        </div>
        
        <!-- 필터 헤더 영역 (Form 제출 방식으로 변경) -->
        <div class="filter-header">
            <form action="/dashboard" method="GET" class="date-filter-form">
                <div class="date-filter-container">
                    <div class="date-input-group">
                        <input type="date" id="startDate" name="start_date" class="date-input" value="{{ initial_data.today }}">
                        <span class="date-separator">~</span>
                        <input type="date" id="endDate" name="end_date" class="date-input" value="{{ initial_data.today }}">
                    </div>
                    <button type="submit" class="btn primary-btn" id="searchDateBtn">
                        <i class="fa-solid fa-search"></i> 조회
                    </button>
                    <a href="/dashboard" class="btn secondary-btn" id="todayBtn">
                        <i class="fa-solid fa-calendar-day"></i> 오늘
                    </a>
                    
                    <div class="page-size-selector">
                        <span>표시 행 수:</span>
                        <select id="pageSize" name="page_size" class="select-field">
                            <option value="10" {% if initial_data.pagination.page_size == 10 %}selected{% endif %}>10행</option>
                            <option value="30" {% if initial_data.pagination.page_size == 30 %}selected{% endif %}>30행</option>
                            <option value="50" {% if initial_data.pagination.page_size == 50 %}selected{% endif %}>50행</option>
                        </select>
                    </div>
                </div>
            </form>

            <form action="/dashboard" method="GET" class="search-form">
                <div class="search-container">
                    <input type="text" id="searchOrderNo" name="order_no" class="search-input" placeholder="주문번호 검색">
                    <button type="submit" class="btn search-button" id="searchOrderBtn">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- 필터 영역 -->
        <div class="filter-box">
            <div class="filter-controls">
                <div class="filter-item">
                    <label for="statusFilter">상태</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="">전체</option>
                        <option value="WAITING">대기</option>
                        <option value="IN_PROGRESS">진행</option>
                        <option value="COMPLETE">완료</option>
                        <option value="ISSUE">이슈</option>
                        <option value="CANCEL">취소</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="departmentFilter">부서</label>
                    <select id="departmentFilter" class="filter-select">
                        <option value="">전체</option>
                        <option value="CS">CS</option>
                        <option value="HES">HES</option>
                        <option value="LENOVO">LENOVO</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="warehouseFilter">창고</label>
                    <select id="warehouseFilter" class="filter-select">
                        <option value="">전체</option>
                        <option value="SEOUL">서울</option>
                        <option value="BUSAN">부산</option>
                        <option value="GWANGJU">광주</option>
                        <option value="DAEJEON">대전</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn primary-btn" id="applyFilterBtn">
                    <i class="fa-solid fa-filter"></i> 필터 적용
                </button>
                <button class="btn secondary-btn" id="resetFilterBtn">
                    <i class="fa-solid fa-rotate-left"></i> 초기화
                </button>
            </div>
        </div>

        <!-- 액션 버튼 -->
        <div class="action-buttons">
            <button class="btn primary-btn" id="refreshBtn">
                <i class="fa-solid fa-arrows-rotate"></i> 새로고침
            </button>
            <a href="/orders/create" class="btn primary-btn">
                <i class="fa-solid fa-plus"></i> 신규 등록
            </a>
            <button class="btn secondary-btn" id="customizeColumnsBtn">
                <i class="fa-solid fa-table-columns"></i> 컬럼 설정
            </button>
        </div>

        <!-- 컬럼 커스터마이징 대화상자 (필요한 컬럼만 포함) -->
        <div id="columnDialog" class="dialog">
            <div class="dialog-content">
                <h3>테이블 컬럼 설정</h3>
                <p>표시할 컬럼을 선택하세요:</p>
                
                <div class="columns-grid" id="columnSettingsGrid">
                    <!-- 기본 컬럼 (항상 표시) -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_order_no" name="columns" value="order_no" checked disabled>
                        <label for="col_order_no">주문번호 (필수)</label>
                    </div>
                    
                    <!-- 선택 가능한 컬럼들 -->
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_customer" name="columns" value="customer" checked>
                        <label for="col_customer">고객</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_type" name="columns" value="type" checked>
                        <label for="col_type">유형</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_status" name="columns" value="status" checked>
                        <label for="col_status">상태</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_department" name="columns" value="department" checked>
                        <label for="col_department">부서</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_warehouse" name="columns" value="warehouse" checked>
                        <label for="col_warehouse">창고</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_eta" name="columns" value="eta" checked>
                        <label for="col_eta">ETA</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_region" name="columns" value="region" checked>
                        <label for="col_region">지역</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="col_driver" name="columns" value="driver" checked>
                        <label for="col_driver">기사명</label>
                    </div>
                </div>
                
                <div class="dialog-actions">
                    <button type="button" class="btn secondary-btn" id="cancelColumnsBtn">취소</button>
                    <button type="button" class="btn primary-btn" id="applyColumnsBtn">적용</button>
                </div>
            </div>
        </div>

        <!-- 락 상태 대화상자는 상세 페이지에서만 사용하므로 목록 페이지에서 제거 -->

                <!-- 통계 카드 영역 제거 -->

        <!-- 데이터 테이블 (체크박스 제거) -->
        <div class="table-container">
            <table class="data-table" id="dashboardTable">
                <thead>
                    <tr>
                        <th>주문번호</th>
                        <th>고객</th>
                        <th>유형</th>
                        <th>상태</th>
                        <th>부서</th>
                        <th>창고</th>
                        <th>ETA</th>
                        <th>지역</th>
                        <th>배송기사</th>
                    </tr>
                </thead>
                <tbody id="dashboardTableBody">
                    {% if initial_data.orders %}
                        {% for order in initial_data.orders %}
                        <tr class="status-{{ order.status|lower }}" data-id="{{ order.dashboardId }}" style="cursor: pointer;">
                            <td>
                                <a href="/orders/{{ order.dashboardId }}" class="order-number">{{ order.orderNo }}</a>
                            </td>
                            <td>{{ order.customer }}</td>
                            <td>{{ order.typeLabel }}</td>
                            <td>
                                <span class="status-badge status-{{ order.status|lower }}">{{ order.statusLabel }}</span>
                            </td>
                            <td>{{ order.department }}</td>
                            <td>{{ order.warehouse }}</td>
                            <td>{{ order.eta }}</td>
                            <td>{{ order.region }}</td>
                            <td>{{ order.driverName }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <!-- 데이터 없음 표시 행 -->
                        <tr class="empty-data-row">
                            <td colspan="9" class="empty-table">
                                <div class="empty-placeholder">
                                    <i class="fa-solid fa-inbox"></i>
                                    <p>조건에 맞는 주문이 없습니다</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination" id="pagination">
            <button class="page-btn" data-page="prev" {% if initial_data.pagination.current_page <= 1 %}disabled{% endif %}>
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <span class="page-info" id="pageInfo">{{ initial_data.pagination.current_page }} / {{ initial_data.pagination.total_pages }}</span>
            <button class="page-btn" data-page="next" {% if initial_data.pagination.current_page >= initial_data.pagination.total_pages %}disabled{% endif %}>
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <!-- 로딩 오버레이 -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <i class="fa-solid fa-spinner loading-spinner"></i>
                <span>데이터를 불러오는 중...</span>
            </div>
        </div>
        
        <!-- 필터 태그 영역 제거 -->
    </div>
</div>

<!-- 필터 표시 스타일 (개선된 디자인) -->
<style>
/* 활성 필터 표시 영역 */
.active-filters {
    margin-top: 15px;
    padding: 10px;
    border-top: 1px solid #eee;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    display: none; /* 기본적으로 숨김, 필터 적용시 표시 */
}

.filter-header {
    font-weight: bold;
    color: #666;
}

.filter-label {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    background-color: var(--primary-color-light);
    color: var(--primary-color);
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 500;
}

.filter-label:empty {
    display: none;
}

/* 상태 요약 배지 */
.status-summary {
    margin: 15px 0;
    display: flex;
    justify-content: flex-end;
}

.status-badge-container {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.status-count-badge {
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-total {
    background-color: var(--background-color-light);
    color: var(--text-color-secondary);
}

.status-waiting {
    background-color: var(--status-waiting-bg);
    color: var(--status-waiting-text);
}

.status-progress {
    background-color: var(--status-progress-bg);
    color: var(--status-progress-text);
}

.status-complete {
    background-color: var(--status-complete-bg);
    color: var(--status-complete-text);
}

.status-issue {
    background-color: var(--status-issue-bg);
    color: var(--status-issue-text);
}

/* 필터 선택에 활성화 스타일 */
.filter-select.filter-active {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(215, 37, 25, 0.1);
}

/* 락 메커니즘 개선 */
.lock-details {
    margin: 15px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    font-size: 0.9em;
}

.lock-suggestion {
    margin-top: 15px;
    padding: 10px;
    background-color: #fff8e1;
    border-left: 3px solid #ffc107;
    border-radius: 0 4px 4px 0;
}

.suggestion-text {
    margin: 0;
    color: #5a5a5a;
    font-size: 0.9em;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.page-title {
    margin: 0;
    color: #333;
}

.page-subtitle {
    color: #777;
    margin: 5px 0 0 0;
}
</style>
{% endblock %}

{% block page_js %}
<!-- 서버에서 전달된 초기 데이터를 JavaScript 변수로 선언 -->
<script>
    // 서버에서 전달된 초기 데이터
    const initialData = {{ initial_data|tojson }};
</script>
<script src="{{ url_for('static', path='js/dashboard.js') }}"></script>
{% endblock %}
