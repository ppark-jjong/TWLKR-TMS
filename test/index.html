<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>배송 관제 시스템 - 대시보드</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      /* 대시보드 특정 스타일 */
      .dashboard-tabs {
        display: flex;
        margin-bottom: 16px;
        border-bottom: 1px solid #e8e8e8;
      }

      .dashboard-tab {
        padding: 12px 16px;
        cursor: pointer;
        margin-right: 8px;
        border-radius: 4px 4px 0 0;
      }

      .dashboard-tab.active {
        background-color: #1890ff;
        color: white;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .dashboard-csv-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 13px;
      }

      .dashboard-csv-table th,
      .dashboard-csv-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      .dashboard-csv-table th {
        background-color: #f2f2f2;
        position: sticky;
        top: 0;
      }

      .dashboard-csv-wrapper {
        overflow-x: auto;
        max-width: 100%;
        max-height: 600px;
        overflow-y: auto;
      }

      .summary-card {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 16px;
      }

      .summary-item {
        flex: 1;
        min-width: 200px;
        padding: 16px;
        background-color: #fafafa;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .summary-title {
        font-size: 14px;
        color: #888;
        margin-bottom: 8px;
      }

      .summary-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }

      .summary-item.waiting {
        border-left: 4px solid #faad14;
      }
      .summary-item.in-progress {
        border-left: 4px solid #1890ff;
      }
      .summary-item.complete {
        border-left: 4px solid #52c41a;
      }
      .summary-item.issue {
        border-left: 4px solid #f5222d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 사이드바 -->
      <div id="sidebar" class="sidebar">
        <div class="logo">
          <span class="logo-text">TMS System</span>
        </div>
        <ul class="menu">
          <li class="menu-item active" data-page="dashboard">대시보드</li>
          <li class="menu-item" data-page="handover">인수인계</li>
          <li class="menu-item" data-page="users">사용자 관리</li>
        </ul>
        <div class="sidebar-user-info">
          <div class="user-dropdown">
            <div class="user-info">
              <div class="user-name">관리자</div>
              <div class="user-dept">관리부</div>
            </div>
          </div>
        </div>
        <div class="sidebar-trigger" id="sidebarToggle">◀</div>
      </div>

      <!-- 메인 콘텐츠 영역 -->
      <div id="mainContent" class="main-content">
        <div id="dashboardPage" class="dashboard-page">
          <div class="dashboard-card">
            <h2 class="card-title">배송 관제 대시보드</h2>

            <!-- 요약 정보 -->
            <div class="summary-card">
              <div class="summary-item waiting">
                <div class="summary-title">대기 중</div>
                <div class="summary-value" id="waitingCount">0</div>
              </div>
              <div class="summary-item in-progress">
                <div class="summary-title">진행 중</div>
                <div class="summary-value" id="inProgressCount">0</div>
              </div>
              <div class="summary-item complete">
                <div class="summary-title">완료</div>
                <div class="summary-value" id="completeCount">0</div>
              </div>
              <div class="summary-item issue">
                <div class="summary-title">이슈</div>
                <div class="summary-value" id="issueCount">0</div>
              </div>
            </div>

            <!-- 탭 메뉴 -->
            <div class="dashboard-tabs">
              <div class="dashboard-tab active" data-tab="order-tab">
                주문 관리
              </div>
              <div class="dashboard-tab" data-tab="csv-tab">CSV 데이터</div>
            </div>

            <!-- 주문 관리 탭 -->
            <div id="order-tab" class="tab-content active">
              <div class="search-container">
                <div class="date-range-container">
                  <input type="date" class="date-input" id="startDate" />
                  <span class="date-separator">~</span>
                  <input type="date" class="date-input" id="endDate" />
                </div>
                <input
                  type="text"
                  class="search-input"
                  id="searchInput"
                  placeholder="주문번호, 고객명 검색"
                />
                <button class="search-btn" id="searchBtn">검색</button>
              </div>

              <div class="filter-container">
                <select class="filter-select" id="statusFilter">
                  <option value="">상태 선택</option>
                  <option value="WAITING">대기</option>
                  <option value="IN_PROGRESS">진행</option>
                  <option value="COMPLETE">완료</option>
                  <option value="ISSUE">이슈</option>
                  <option value="CANCEL">취소</option>
                </select>

                <select class="filter-select" id="departmentFilter">
                  <option value="">부서 선택</option>
                  <option value="CS">CS</option>
                  <option value="HES">HES</option>
                  <option value="LENOVO">LENOVO</option>
                </select>

                <select class="filter-select" id="warehouseFilter">
                  <option value="">창고 선택</option>
                  <option value="서울창고">서울창고</option>
                  <option value="부산창고">부산창고</option>
                  <option value="대구창고">대구창고</option>
                  <option value="인천창고">인천창고</option>
                </select>

                <button class="action-btn" id="resetFilterBtn">
                  필터 초기화
                </button>
              </div>

              <div class="action-container">
                <div class="action-group">
                  <button class="action-btn primary" id="assignBtn">
                    배차 처리
                  </button>
                  <button class="action-btn primary" id="addOrderBtn">
                    주문 추가
                  </button>
                </div>
                <div class="action-group">
                  <button class="action-btn danger" id="deleteBtn">
                    선택 삭제
                  </button>
                  <button class="action-btn" id="downloadExcelBtn">
                    엑셀 다운로드
                  </button>
                  <button class="action-btn" id="refreshBtn">새로고침</button>
                </div>
              </div>

              <table class="dashboard-table" id="adminTable">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAllCheckbox" /></th>
                    <th>주문번호</th>
                    <th>고객</th>
                    <th>유형</th>
                    <th>상태</th>
                    <th>부서</th>
                    <th>창고</th>
                    <th>ETA</th>
                    <th>배송기사</th>
                    <th>액션</th>
                  </tr>
                </thead>
                <tbody id="adminTableBody">
                  <!-- JavaScript로 동적 생성 -->
                </tbody>
              </table>

              <div class="pagination" id="adminPagination">
                <!-- JavaScript로 동적 생성 -->
              </div>
            </div>

            <!-- CSV 데이터 탭 -->
            <div id="csv-tab" class="tab-content">
              <div class="action-container">
                <button id="exportCsvBtn" class="action-btn primary">
                  CSV 내보내기
                </button>
              </div>

              <div class="dashboard-csv-wrapper">
                <table id="dashboardCsvTable" class="dashboard-csv-table">
                  <thead>
                    <tr>
                      <th>dashboard_id</th>
                      <th>order_no</th>
                      <th>type</th>
                      <th>status</th>
                      <th>department</th>
                      <th>warehouse</th>
                      <th>sla</th>
                      <th>eta</th>
                      <th>create_time</th>
                      <th>depart_time</th>
                      <th>complete_time</th>
                      <th>postal_code</th>
                      <th>address</th>
                      <th>customer</th>
                      <th>remark</th>
                      <th>driver_name</th>
                      <th>driver_contact</th>
                      <th>update_at</th>
                    </tr>
                  </thead>
                  <tbody id="dashboardCsvBody">
                    <!-- JavaScript로 동적 생성 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 상태 변경 모달 -->
    <div id="statusModal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">상태 변경</h3>
          <button class="modal-close" id="statusModalClose">✕</button>
        </div>
        <div class="modal-body">
          <div class="modal-info">
            <div>
              <strong>주문번호:</strong> <span id="modalOrderNo"></span>
            </div>
            <div><strong>고객명:</strong> <span id="modalCustomer"></span></div>
            <div>
              <strong>현재 상태:</strong> <span id="modalCurrentStatus"></span>
            </div>
          </div>

          <div class="form-group">
            <label for="statusSelect"><strong>변경할 상태:</strong></label>
            <select id="statusSelect" class="form-select">
              <option value="WAITING">대기</option>
              <option value="IN_PROGRESS">진행</option>
              <option value="COMPLETE">완료</option>
              <option value="ISSUE">이슈</option>
              <option value="CANCEL">취소</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-btn" id="statusModalCancel">취소</button>
          <button class="action-btn primary" id="statusModalSubmit">
            확인
          </button>
        </div>
      </div>
    </div>

    <!-- 배차 처리 모달 -->
    <div id="assignModal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">배차 처리</h3>
          <button class="modal-close" id="assignModalClose">✕</button>
        </div>
        <div class="modal-body">
          <div class="modal-info">
            <strong>선택된 주문:</strong> <span id="selectedCount">0</span>건
          </div>

          <div class="form-group">
            <label for="driverName"><strong>기사명:</strong></label>
            <input
              type="text"
              id="driverName"
              class="form-control"
              placeholder="기사명 입력"
            />
          </div>

          <div class="form-group">
            <label for="driverContact"><strong>연락처:</strong></label>
            <input
              type="text"
              id="driverContact"
              class="form-control"
              placeholder="연락처 입력 (예: 010-1234-5678)"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-btn" id="assignModalCancel">취소</button>
          <button class="action-btn primary" id="assignModalSubmit">
            확인
          </button>
        </div>
      </div>
    </div>

    <!-- 주문 추가 모달 -->
    <div id="orderModal" class="modal-overlay hidden">
      <div class="modal modal-large">
        <div class="modal-header">
          <h3 class="modal-title">주문 추가</h3>
          <button class="modal-close" id="orderModalClose">✕</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="orderNo"><strong>주문번호:</strong></label>
            <input
              type="text"
              id="orderNo"
              class="form-control"
              placeholder="주문번호 입력"
            />
          </div>

          <div class="form-group">
            <label for="customerName"><strong>고객명:</strong></label>
            <input
              type="text"
              id="customerName"
              class="form-control"
              placeholder="고객명 입력"
            />
          </div>

          <div class="form-group">
            <label for="orderType"><strong>유형:</strong></label>
            <select id="orderType" class="form-select">
              <option value="DELIVERY">배송</option>
              <option value="RETURN">회수</option>
            </select>
          </div>

          <div class="form-group">
            <label for="orderDepartment"><strong>부서:</strong></label>
            <select id="orderDepartment" class="form-select">
              <option value="CS">CS</option>
              <option value="HES">HES</option>
              <option value="LENOVO">LENOVO</option>
            </select>
          </div>

          <div class="form-group">
            <label for="orderWarehouse"><strong>창고:</strong></label>
            <select id="orderWarehouse" class="form-select">
              <option value="서울창고">서울창고</option>
              <option value="부산창고">부산창고</option>
              <option value="대구창고">대구창고</option>
              <option value="인천창고">인천창고</option>
            </select>
          </div>

          <div class="form-group">
            <label for="orderPostalCode"><strong>우편번호:</strong></label>
            <input
              type="text"
              id="orderPostalCode"
              class="form-control"
              placeholder="우편번호 입력 (예: 12345)"
            />
          </div>

          <div class="form-group">
            <label for="orderAddress"><strong>주소:</strong></label>
            <input
              type="text"
              id="orderAddress"
              class="form-control"
              placeholder="주소 입력"
            />
          </div>

          <div class="form-group">
            <label for="orderEta"><strong>예상 도착 시간(ETA):</strong></label>
            <input type="datetime-local" id="orderEta" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-btn" id="orderModalCancel">취소</button>
          <button class="action-btn primary" id="orderModalSubmit">추가</button>
        </div>
      </div>
    </div>

    <!-- 스크립트 -->
    <script src="js/mock-data.js"></script>
    <script>
      // 전역 변수
      let selectedRows = new Set();
      let currentStatusItem = null;
      let filteredData = [];
      let currentPage = 1;
      let itemsPerPage = 10;

      // 페이지 로드 시 실행
      document.addEventListener('DOMContentLoaded', function () {
        // 초기 데이터 설정
        filteredData = [...dashboardData];

        // 사이드바 토글 이벤트 리스너
        document
          .getElementById('sidebarToggle')
          .addEventListener('click', toggleSidebar);

        // 메뉴 아이템 이벤트 리스너
        document.querySelectorAll('.menu-item').forEach((item) => {
          item.addEventListener('click', function () {
            navigateToPage(this.dataset.page);
          });
        });

        // 탭 전환 이벤트 리스너
        document.querySelectorAll('.dashboard-tab').forEach((tab) => {
          tab.addEventListener('click', function () {
            // 활성 탭 변경
            document
              .querySelectorAll('.dashboard-tab')
              .forEach((t) => t.classList.remove('active'));
            this.classList.add('active');

            // 탭 콘텐츠 변경
            const tabId = this.dataset.tab;
            document.querySelectorAll('.tab-content').forEach((content) => {
              content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            // CSV 탭이 활성화되면 데이터 렌더링
            if (tabId === 'csv-tab') {
              renderCsvTable();
            }
          });
        });

        // 현재 날짜 설정
        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setMonth(today.getMonth() - 1);

        document.getElementById('startDate').valueAsDate = lastMonth;
        document.getElementById('endDate').valueAsDate = today;

        // 주문 관리 이벤트 리스너
        document
          .getElementById('searchBtn')
          .addEventListener('click', handleSearch);
        document
          .getElementById('resetFilterBtn')
          .addEventListener('click', resetFilters);
        document
          .getElementById('refreshBtn')
          .addEventListener('click', function () {
            filteredData = [...dashboardData];
            renderAdminTable(currentPage);
            updateSummary();
          });
        document
          .getElementById('assignBtn')
          .addEventListener('click', showAssignModal);
        document
          .getElementById('deleteBtn')
          .addEventListener('click', handleDelete);
        document
          .getElementById('downloadExcelBtn')
          .addEventListener('click', function () {
            alert('엑셀 파일 다운로드가 시작되었습니다.');
          });
        document
          .getElementById('addOrderBtn')
          .addEventListener('click', function () {
            toggleModal('orderModal', true);
          });
        document
          .getElementById('exportCsvBtn')
          .addEventListener('click', exportToCsv);

        // 전체 선택 체크박스 이벤트 리스너
        document
          .getElementById('selectAllCheckbox')
          .addEventListener('change', function () {
            const checkboxes = document.querySelectorAll(
              '#adminTableBody input[type="checkbox"]'
            );
            checkboxes.forEach((checkbox) => {
              checkbox.checked = this.checked;
              const rowId = checkbox.dataset.id;
              if (this.checked) {
                selectedRows.add(parseInt(rowId));
              } else {
                selectedRows.delete(parseInt(rowId));
              }
            });
          });

        // 상태 모달 이벤트 리스너
        document
          .getElementById('statusModalClose')
          .addEventListener('click', function () {
            toggleModal('statusModal', false);
          });
        document
          .getElementById('statusModalCancel')
          .addEventListener('click', function () {
            toggleModal('statusModal', false);
          });
        document
          .getElementById('statusModalSubmit')
          .addEventListener('click', handleStatusChange);

        // 배차 모달 이벤트 리스너
        document
          .getElementById('assignModalClose')
          .addEventListener('click', function () {
            toggleModal('assignModal', false);
          });
        document
          .getElementById('assignModalCancel')
          .addEventListener('click', function () {
            toggleModal('assignModal', false);
          });
        document
          .getElementById('assignModalSubmit')
          .addEventListener('click', handleAssign);

        // 주문 추가 모달 이벤트 리스너
        document
          .getElementById('orderModalClose')
          .addEventListener('click', function () {
            toggleModal('orderModal', false);
          });
        document
          .getElementById('orderModalCancel')
          .addEventListener('click', function () {
            toggleModal('orderModal', false);
          });
        document
          .getElementById('orderModalSubmit')
          .addEventListener('click', handleAddOrder);

        // 페이지 초기 렌더링
        renderAdminTable(currentPage);
        updateSummary();
      });

      // 사이드바 토글
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        sidebar.classList.toggle('sidebar-collapsed');
        mainContent.classList.toggle('main-content-full');

        const toggleBtn = document.getElementById('sidebarToggle');
        toggleBtn.textContent = sidebar.classList.contains('sidebar-collapsed')
          ? '▶'
          : '◀';
      }

      // 페이지 이동
      function navigateToPage(page) {
        switch (page) {
          case 'dashboard':
            // 현재 페이지이므로 아무 작업 없음
            break;
          case 'handover':
            window.location.href = 'handover.html';
            break;
          case 'users':
            window.location.href = 'users.html';
            break;
        }
      }

      // 요약 정보 업데이트
      function updateSummary() {
        // 상태별 카운트 계산
        const statusCounts = {
          WAITING: 0,
          IN_PROGRESS: 0,
          COMPLETE: 0,
          ISSUE: 0,
        };

        dashboardData.forEach((item) => {
          if (statusCounts.hasOwnProperty(item.status)) {
            statusCounts[item.status]++;
          }
        });

        // UI 업데이트
        document.getElementById('waitingCount').textContent =
          statusCounts.WAITING;
        document.getElementById('inProgressCount').textContent =
          statusCounts.IN_PROGRESS;
        document.getElementById('completeCount').textContent =
          statusCounts.COMPLETE;
        document.getElementById('issueCount').textContent = statusCounts.ISSUE;
      }

      // 관리자 테이블 렌더링
      function renderAdminTable(page) {
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = '';

        // 페이징 처리
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedData = filteredData.slice(startIndex, endIndex);

        // 테이블 데이터 렌더링
        paginatedData.forEach((item) => {
          const tr = document.createElement('tr');

          // 체크박스 셀
          const checkboxCell = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.dataset.id = item.dashboard_id;
          checkbox.addEventListener('change', function () {
            if (this.checked) {
              selectedRows.add(parseInt(this.dataset.id));
            } else {
              selectedRows.delete(parseInt(this.dataset.id));
            }
          });
          checkboxCell.appendChild(checkbox);
          tr.appendChild(checkboxCell);

          // 주문번호
          tr.appendChild(createCell(item.order_no));

          // 고객
          tr.appendChild(createCell(item.customer));

          // 유형
          const typeCell = document.createElement('td');
          const typeTag = document.createElement('span');
          typeTag.className = `tag tag-${typeMap[item.type].color}`;
          typeTag.textContent = typeMap[item.type].text;
          typeCell.appendChild(typeTag);
          tr.appendChild(typeCell);

          // 상태
          const statusCell = document.createElement('td');
          const statusTag = document.createElement('span');
          statusTag.className = `tag tag-${statusMap[item.status].color}`;
          statusTag.textContent = statusMap[item.status].text;
          statusCell.appendChild(statusTag);
          tr.appendChild(statusCell);

          // 부서, 창고, ETA, 배송기사
          tr.appendChild(createCell(item.department));
          tr.appendChild(createCell(item.warehouse));
          tr.appendChild(createCell(item.eta));
          tr.appendChild(createCell(item.driver_name || '-'));

          // 액션
          const actionCell = document.createElement('td');
          const actionButton = document.createElement('button');
          actionButton.className = 'action-button';
          actionButton.textContent = '상태변경';
          actionButton.addEventListener('click', function (e) {
            e.stopPropagation();
            showStatusModal(item);
          });
          actionCell.appendChild(actionButton);
          tr.appendChild(actionCell);

          // 행 클릭 이벤트
          tr.addEventListener('click', function () {
            showOrderDetail(item);
          });

          tbody.appendChild(tr);
        });

        // 페이지네이션 렌더링
        renderPagination();
      }

      // CSV 테이블 렌더링
      function renderCsvTable() {
        const tbody = document.getElementById('dashboardCsvBody');
        tbody.innerHTML = '';

        // 테이블 데이터 렌더링 (모든 데이터 표시)
        dashboardData.forEach((item) => {
          const tr = document.createElement('tr');

          // dashboard.csv의 주요 컬럼에 대해 셀 생성
          tr.appendChild(createCell(item.dashboard_id || ''));
          tr.appendChild(createCell(item.order_no || ''));
          tr.appendChild(createCell(item.type || ''));
          tr.appendChild(createCell(item.status || ''));
          tr.appendChild(createCell(item.department || ''));
          tr.appendChild(createCell(item.warehouse || ''));
          tr.appendChild(createCell(item.sla || ''));
          tr.appendChild(createCell(item.eta || ''));
          tr.appendChild(createCell(item.create_time || ''));
          tr.appendChild(createCell(item.depart_time || ''));
          tr.appendChild(createCell(item.complete_time || ''));
          tr.appendChild(createCell(item.postal_code || ''));
          tr.appendChild(createCell(item.address || ''));
          tr.appendChild(createCell(item.customer || ''));
          tr.appendChild(createCell(item.remark || ''));
          tr.appendChild(createCell(item.driver_name || ''));
          tr.appendChild(createCell(item.driver_contact || ''));
          tr.appendChild(createCell(item.update_at || ''));

          tbody.appendChild(tr);
        });
      }

      // 페이지네이션 렌더링
      function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const pagination = document.getElementById('adminPagination');
        pagination.innerHTML = '';

        // 처음 페이지 버튼
        if (currentPage > 1) {
          const firstBtn = createPaginationButton('<<', 1);
          pagination.appendChild(firstBtn);
        }

        // 이전 페이지 버튼
        if (currentPage > 1) {
          const prevBtn = createPaginationButton('<', currentPage - 1);
          pagination.appendChild(prevBtn);
        }

        // 페이지 번호 버튼
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = createPaginationButton(i, i);
          if (i === currentPage) {
            pageBtn.classList.add('active');
          }
          pagination.appendChild(pageBtn);
        }

        // 다음 페이지 버튼
        if (currentPage < totalPages) {
          const nextBtn = createPaginationButton('>', currentPage + 1);
          pagination.appendChild(nextBtn);
        }

        // 마지막 페이지 버튼
        if (currentPage < totalPages) {
          const lastBtn = createPaginationButton('>>', totalPages);
          pagination.appendChild(lastBtn);
        }
      }

      // 페이지네이션 버튼 생성
      function createPaginationButton(text, pageNum) {
        const btn = document.createElement('button');
        btn.className = 'pagination-btn';
        btn.textContent = text;
        btn.addEventListener('click', function () {
          currentPage = pageNum;
          renderAdminTable(currentPage);
        });
        return btn;
      }

      // 셀 생성 헬퍼 함수
      function createCell(text) {
        const td = document.createElement('td');
        td.textContent = text;
        return td;
      }

      // 주문 상세 정보 표시
      function showOrderDetail(item) {
        alert(
          `주문 상세 정보:\n\n` +
            `주문번호: ${item.order_no}\n` +
            `고객명: ${item.customer}\n` +
            `주소: ${item.address}\n` +
            `상태: ${statusMap[item.status].text}\n` +
            `배송기사: ${item.driver_name || '미배정'}\n` +
            `연락처: ${item.driver_contact || '-'}\n` +
            `SLA: ${item.sla || '-'}\n` +
            `예상 도착: ${item.eta || '-'}\n` +
            `배송 출발: ${item.depart_time || '-'}\n` +
            `배송 완료: ${item.complete_time || '-'}\n` +
            `우편번호: ${item.postal_code || '-'}\n` +
            `비고: ${item.remark || '없음'}`
        );
      }

      // 검색 처리
      function handleSearch() {
        const searchTerm = document
          .getElementById('searchInput')
          .value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const departmentFilter =
          document.getElementById('departmentFilter').value;
        const warehouseFilter =
          document.getElementById('warehouseFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        filteredData = dashboardData.filter((item) => {
          // 검색어 필터링
          const matchesSearch =
            searchTerm === '' ||
            item.order_no.toLowerCase().includes(searchTerm) ||
            item.customer.toLowerCase().includes(searchTerm);

          // 상태 필터링
          const matchesStatus =
            statusFilter === '' || item.status === statusFilter;

          // 부서 필터링
          const matchesDepartment =
            departmentFilter === '' || item.department === departmentFilter;

          // 창고 필터링
          const matchesWarehouse =
            warehouseFilter === '' || item.warehouse === warehouseFilter;

          // 날짜 필터링
          const itemDate = item.created_at.split(' ')[0];
          const matchesDate =
            (!startDate || itemDate >= startDate) &&
            (!endDate || itemDate <= endDate);

          return (
            matchesSearch &&
            matchesStatus &&
            matchesDepartment &&
            matchesWarehouse &&
            matchesDate
          );
        });

        currentPage = 1; // 검색 시 첫 페이지로 이동
        renderAdminTable(currentPage);
      }

      // 필터 초기화
      function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('departmentFilter').value = '';
        document.getElementById('warehouseFilter').value = '';

        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setMonth(today.getMonth() - 1);

        document.getElementById('startDate').valueAsDate = lastMonth;
        document.getElementById('endDate').valueAsDate = today;

        filteredData = [...dashboardData];
        currentPage = 1;
        renderAdminTable(currentPage);
      }

      // 상태 변경 모달 표시
      function showStatusModal(item) {
        currentStatusItem = item;

        document.getElementById('modalOrderNo').textContent = item.order_no;
        document.getElementById('modalCustomer').textContent = item.customer;

        const statusTag = document.createElement('span');
        statusTag.className = `tag tag-${statusMap[item.status].color}`;
        statusTag.textContent = statusMap[item.status].text;

        const modalCurrentStatus =
          document.getElementById('modalCurrentStatus');
        modalCurrentStatus.innerHTML = '';
        modalCurrentStatus.appendChild(statusTag);

        document.getElementById('statusSelect').value = item.status;

        toggleModal('statusModal', true);
      }

      // 상태 변경 처리
      function handleStatusChange() {
        if (!currentStatusItem) return;

        const newStatus = document.getElementById('statusSelect').value;

        // 모의 데이터 업데이트
        dashboardData.forEach((item) => {
          if (item.dashboard_id === currentStatusItem.dashboard_id) {
            item.status = newStatus;
            item.updated_at = getCurrentDateTime();
          }
        });

        // 필터링된 데이터도 업데이트
        filteredData.forEach((item) => {
          if (item.dashboard_id === currentStatusItem.dashboard_id) {
            item.status = newStatus;
            item.updated_at = getCurrentDateTime();
          }
        });

        // 테이블 새로고침
        renderAdminTable(currentPage);
        updateSummary();

        // 모달 닫기
        toggleModal('statusModal', false);

        alert('상태가 변경되었습니다.');
      }

      // 배차 모달 표시
      function showAssignModal() {
        const checkboxes = document.querySelectorAll(
          '#adminTableBody input[type="checkbox"]:checked'
        );

        if (checkboxes.length === 0) {
          alert('배차할 항목을 선택해주세요.');
          return;
        }

        document.getElementById('selectedCount').textContent =
          checkboxes.length;
        toggleModal('assignModal', true);
      }

      // 배차 처리
      function handleAssign() {
        const driverName = document.getElementById('driverName').value;
        const driverContact = document.getElementById('driverContact').value;

        if (!driverName) {
          alert('기사명을 입력해주세요.');
          return;
        }

        if (!driverContact) {
          alert('연락처를 입력해주세요.');
          return;
        }

        // 체크된 항목 ID 수집
        const selectedIds = Array.from(selectedRows);

        // 모의 데이터 업데이트
        dashboardData.forEach((item) => {
          if (selectedIds.includes(item.dashboard_id)) {
            item.driver_name = driverName;
            item.driver_contact = driverContact;
            item.status = 'IN_PROGRESS'; // 배차 시 상태를 진행 중으로 변경
            item.updated_at = getCurrentDateTime();
          }
        });

        // 필터링된 데이터도 업데이트
        filteredData.forEach((item) => {
          if (selectedIds.includes(item.dashboard_id)) {
            item.driver_name = driverName;
            item.driver_contact = driverContact;
            item.status = 'IN_PROGRESS';
            item.updated_at = getCurrentDateTime();
          }
        });

        // 테이블 새로고침
        renderAdminTable(currentPage);
        updateSummary();

        // 모달 닫기
        toggleModal('assignModal', false);

        // 선택 초기화
        selectedRows.clear();
        document.getElementById('selectAllCheckbox').checked = false;

        alert('배차가 완료되었습니다.');
      }

      // 주문 추가 처리
      function handleAddOrder() {
        const orderNo = document.getElementById('orderNo').value;
        const customer = document.getElementById('customerName').value;
        const type = document.getElementById('orderType').value;
        const department = document.getElementById('orderDepartment').value;
        const warehouse = document.getElementById('orderWarehouse').value;
        const postalCode = document.getElementById('orderPostalCode').value;
        const address = document.getElementById('orderAddress').value;
        const eta = document.getElementById('orderEta').value;

        if (!orderNo || !customer || !postalCode || !address || !eta) {
          alert('필수 항목을 모두 입력해주세요.');
          return;
        }

        const etaFormatted = eta.replace('T', ' ');
        const now = getCurrentDateTime();

        // 새 주문 생성
        const newOrder = {
          dashboard_id:
            Math.max(...dashboardData.map((item) => item.dashboard_id)) + 1,
          order_no: orderNo,
          customer: customer,
          type: type,
          status: 'WAITING',
          department: department,
          warehouse: warehouse,
          postal_code: parseInt(postalCode),
          address: address,
          eta: etaFormatted,
          driver_name: '',
          driver_contact: '',
          created_at: now,
          updated_at: now,

          // CSV 형식의 추가 필드
          sla: '4HR(8X5)',
          create_time: now,
          depart_time: '',
          complete_time: '',
          city: '',
          district: '',
          region: '',
          remark: '',
          'driver_contact.1': '',
        };

        // 데이터 추가
        dashboardData.push(newOrder);
        filteredData.push(newOrder);

        // 테이블 새로고침
        renderAdminTable(currentPage);
        updateSummary();

        // 모달 닫기
        toggleModal('orderModal', false);

        // 폼 초기화
        document.getElementById('orderNo').value = '';
        document.getElementById('customerName').value = '';
        document.getElementById('orderPostalCode').value = '';
        document.getElementById('orderAddress').value = '';
        document.getElementById('orderEta').value = '';

        alert('주문이 추가되었습니다.');
      }

      // 주문 삭제 처리
      function handleDelete() {
        const selectedIds = Array.from(selectedRows);

        if (selectedIds.length === 0) {
          alert('삭제할 항목을 선택해주세요.');
          return;
        }

        if (
          confirm(`선택한 ${selectedIds.length}개 항목을 삭제하시겠습니까?`)
        ) {
          // 모의 데이터에서 삭제
          for (let i = dashboardData.length - 1; i >= 0; i--) {
            if (selectedIds.includes(dashboardData[i].dashboard_id)) {
              dashboardData.splice(i, 1);
            }
          }

          // 필터링된 데이터에서도 삭제
          for (let i = filteredData.length - 1; i >= 0; i--) {
            if (selectedIds.includes(filteredData[i].dashboard_id)) {
              filteredData.splice(i, 1);
            }
          }

          // 테이블 새로고침
          renderAdminTable(currentPage);
          updateSummary();

          // 선택 초기화
          selectedRows.clear();
          document.getElementById('selectAllCheckbox').checked = false;

          alert('선택한 항목이 삭제되었습니다.');
        }
      }

      // CSV로 내보내기 함수
      function exportToCsv() {
        // CSV 헤더 생성
        const headers = [
          'dashboard_id',
          'order_no',
          'type',
          'status',
          'department',
          'warehouse',
          'sla',
          'eta',
          'create_time',
          'depart_time',
          'complete_time',
          'postal_code',
          'address',
          'customer',
          'remark',
          'driver_name',
          'driver_contact',
          'update_at',
        ];

        // CSV 데이터 행 생성
        const rows = dashboardData.map((item) => {
          return [
            item.dashboard_id || '',
            item.order_no || '',
            item.type || '',
            item.status || '',
            item.department || '',
            item.warehouse || '',
            item.sla || '',
            item.eta || '',
            item.create_time || '',
            item.depart_time || '',
            item.complete_time || '',
            item.postal_code || '',
            `"${(item.address || '').replace(/"/g, '""')}"`,
            `"${(item.customer || '').replace(/"/g, '""')}"`,
            `"${(item.remark || '').replace(/"/g, '""')}"`,
            item.driver_name || '',
            item.driver_contact || '',
            item.updated_at || '',
          ].join(',');
        });

        // CSV 문자열 생성
        const csvContent = [headers.join(','), ...rows].join('\n');

        // 다운로드 링크 생성
        const blob = new Blob([csvContent], {
          type: 'text/csv;charset=utf-8;',
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'dashboard.csv');
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        alert('CSV 파일이 다운로드되었습니다.');
      }

      // 모달 토글
      function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (show) {
          modal.classList.remove('hidden');
        } else {
          modal.classList.add('hidden');
        }
      }

      // 현재 날짜/시간 포맷팅
      function getCurrentDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }
    </script>
  </body>
</html>
