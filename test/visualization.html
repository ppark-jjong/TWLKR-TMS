<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TeckwahTMS - 시각화</title>
  
  <!-- 파비콘 -->
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
  
  <!-- Ant Design CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.11.0/dist/reset.css">
  
  <!-- 사용자 정의 CSS -->
  <link rel="stylesheet" href="styles/simple.css">
  
  <!-- 폰트 어썸 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <style>
    /* 시각화 페이지 추가 스타일 */
    .control-panel {
      background-color: #f9f9f9;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .viz-type-selector {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .viz-type-selector h3 {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 10px;
      color: #333;
    }
    
    .date-filter-section {
      margin-top: 0;
      padding: 0;
      background-color: transparent;
      border: none;
    }
    
    .date-filter-title {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .date-filter-label {
      font-size: 1rem;
      font-weight: 500;
      color: #333;
    }
    
    .date-column-indicator {
      font-size: 0.85rem;
      color: #666;
      background-color: #f0f0f0;
      padding: 3px 8px;
      border-radius: 4px;
      margin-left: 8px;
    }
    
    .daterange-picker {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .date-input-group {
      display: flex;
      align-items: center;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      overflow: hidden;
      background-color: white;
    }
    
    .date-input {
      border: none;
      padding: 8px 12px;
      outline: none;
      font-size: 0.9rem;
    }
    
    .date-separator {
      color: #666;
      padding: 0 5px;
    }
    
    .date-label {
      font-size: 0.9rem;
      color: #666;
      margin-left: 8px;
    }
    
    .chart-container {
      padding: 20px;
      height: 400px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin: 20px;
    }
    
    .department-charts {
      padding: 0 20px;
    }
    
    .department-chart-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .department-chart {
      flex: 1;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 16px;
    }
    
    .department-chart h4 {
      margin: 0 0 12px 0;
      font-size: 1rem;
      color: #333;
      font-weight: 500;
      text-align: center;
    }
    
    .department-chart .chart-container {
      height: 250px;
      margin: 0;
      padding: 0;
      box-shadow: none;
    }
    
    /* 로딩 표시 */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
      font-size: 1.2rem;
      color: #1890ff;
    }
    
    .loading-spinner {
      margin-right: 10px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <!-- 레이아웃 -->
    <div class="main-layout">
      <!-- 사이드바 -->
      <aside id="sidebar" class="sidebar">
        <img class="logo" src="assets/logo.png" alt="로고" style="width: 100%; max-width: 200px; margin: 15px auto; display: block;">
        <div class="logo-container" style="align-content: center;">
          <h1>TWLKR-TMS</h1>
        </div>
        
        <div class="user-info">
          <div class="avatar">
            <i class="fa-solid fa-user"></i>
          </div>
          <div class="user-details">
            <p class="user-name">CSAdmin</p>
            <p class="user-role">CS</p>
          </div>
        </div>
        
        <nav class="menu">
          <ul>
            <li class="menu-item">
              <a href="dashboard.html">
                <i class="fa-solid fa-chart-line"></i>
                <span>TMS</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="handover.html">
                <i class="fa-solid fa-right-left"></i>
                <span>Work-Notice</span>
              </a>
            </li>
            <li class="menu-item active">
              <a href="visualization.html">
                <i class="fa-solid fa-chart-bar"></i>
                <span>Visualization</span>
              </a>
            </li>
          </ul>
        </nav>
        
        <div class="logout-container">
          <button id="logoutBtn" class="logout-btn">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>로그아웃</span>
          </button>
        </div>
      </aside>
      
      <!-- 메인 컨텐츠 -->
      <main class="main-content">
        <!-- 컨텐츠 영역 -->
        <div id="content-container" class="content-container">
          <!-- 시각화 페이지 -->
          <div class="page-section" id="visualizationPage">
            <div class="main-card" style="position: relative;">
              <div class="card-header">
                <h2>배송 데이터 시각화</h2>
                <div class="card-actions">
                  <button class="btn primary-btn" id="refreshVisualizationBtn">
                    <i class="fa-solid fa-arrows-rotate"></i> 새로고침
                  </button>
                </div>
              </div>
              
              <!-- 시각화 컨트롤 패널 -->
              <div class="control-panel">
                <!-- 시각화 유형 선택 -->
                <div class="viz-type-selector">
                  <h3>시각화 유형</h3>
                  <select id="vizChartType" class="select-field" style="width: 100%;">
                    <option value="time">시간대별 주문 접수</option>
                    <option value="dept-status">부서별 배송 상태 분포</option>
                  </select>
                </div>
                
                <!-- 날짜 필터 영역 -->
                <div class="date-filter-section">
                  <div class="date-filter-title">
                    <span class="date-filter-label">기간 설정</span>
                    <span class="date-column-indicator" id="dateColumnIndicator">기준: create_time</span>
                  </div>
                  <div class="daterange-picker">
                    <div class="date-input-group">
                      <input type="date" id="vizStartDate" class="date-input">
                      <span class="date-separator">~</span>
                      <input type="date" id="vizEndDate" class="date-input">
                    </div>
                    <span class="date-label" id="vizDateRangeLabel"></span>
                  </div>
                </div>
                
                <!-- 부서 필터 -->
                <div class="filter-item">
                  <label for="vizDepartmentFilter">부서</label>
                  <select id="vizDepartmentFilter" class="filter-select">
                    <option value="">전체</option>
                    <option value="CS">CS</option>
                    <option value="HES">HES</option>
                    <option value="LENOVO">LENOVO</option>
                  </select>
                </div>
                
                <div class="filter-actions" style="margin-top: 16px;">
                  <button class="btn primary-btn" id="applyVizFilterBtn">
                    <i class="fa-solid fa-filter"></i> 필터 적용
                  </button>
                </div>
              </div>
              
              <!-- 차트 영역 -->
              <div class="chart-container" id="mainChartContainer">
                <canvas id="orderTimeChart"></canvas>
              </div>
              
              <!-- 부서별 차트 컨테이너 -->
              <div class="department-charts" id="departmentChartsContainer" style="display: none;">
                <div class="department-chart-row">
                  <div class="department-chart">
                    <h4>CS 부서</h4>
                    <div class="chart-container">
                      <canvas id="csChart"></canvas>
                    </div>
                  </div>
                  <div class="department-chart">
                    <h4>HES 부서</h4>
                    <div class="chart-container">
                      <canvas id="hesChart"></canvas>
                    </div>
                  </div>
                </div>
                <div class="department-chart-row">
                  <div class="department-chart">
                    <h4>LENOVO 부서</h4>
                    <div class="chart-container">
                      <canvas id="lenovoChart"></canvas>
                    </div>
                  </div>
                  <div class="department-chart">
                    <h4>전체 부서 비교</h4>
                    <div class="chart-container">
                      <canvas id="allDeptChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 로딩 오버레이 -->
              <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <i class="fa-solid fa-spinner loading-spinner"></i>
                <span>데이터를 분석하는 중...</span>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <!-- 메시지 팝업 컴포넌트 -->
  <div id="messagePopup" class="message-popup">
    <div class="message-content">
      <i class="fa-solid message-icon"></i>
      <span class="message-text"></span>
    </div>
  </div>
  
  <!-- JavaScript 파일 -->
  <script>
  // 메시지 유틸리티
  const messageUtils = {
    showMessage(message, type = 'info', duration = 3000) {
      const messageEl = document.getElementById('messagePopup');
      if (!messageEl) return;
      
      const messageText = messageEl.querySelector('.message-text');
      const messageIcon = messageEl.querySelector('.message-icon');
      
      // 타입에 따른 아이콘과 클래스 설정
      let iconClass = 'fa-info-circle';
      messageEl.className = 'message-popup';
      
      if (type === 'success') {
        iconClass = 'fa-check-circle';
        messageEl.classList.add('message-success');
      } else if (type === 'error') {
        iconClass = 'fa-times-circle';
        messageEl.classList.add('message-error');
      } else if (type === 'warning') {
        iconClass = 'fa-exclamation-triangle';
        messageEl.classList.add('message-warning');
      } else {
        messageEl.classList.add('message-info');
      }
      
      // 아이콘 및 메시지 설정
      messageIcon.className = `fa-solid ${iconClass} message-icon`;
      messageText.textContent = message;
      
      // 메시지 표시
      messageEl.classList.add('active');
      
      // 타이머 설정
      if (this.messageTimer) {
        clearTimeout(this.messageTimer);
      }
      
      this.messageTimer = setTimeout(() => {
        messageEl.classList.remove('active');
      }, duration);
    },
    
    success(message, duration = 3000) {
      this.showMessage(message, 'success', duration);
    },
    
    error(message, duration = 3000) {
      this.showMessage(message, 'error', duration);
    },
    
    warning(message, duration = 3000) {
      this.showMessage(message, 'warning', duration);
    },
    
    info(message, duration = 3000) {
      this.showMessage(message, 'info', duration);
    }
  };

  // 로딩 표시기 제어
  const loadingUtils = {
    show() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    },
    
    hide() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  };

  // 모의 DB
  let DB = {
    orders: [
      { id: 'ORD-001', customer: '삼성전자', type: '배송', status: 'PENDING', department: 'CS', warehouse: '김포', eta: '2025-03-10', createTime: '2025-03-05 09:15', driver: '김기사' },
      { id: 'ORD-002', customer: 'LG전자', type: '배송', status: 'IN_PROGRESS', department: 'HES', warehouse: '인천', eta: '2025-03-11', createTime: '2025-03-06 10:30', driver: '이기사' },
      { id: 'ORD-003', customer: '현대', type: '회수', status: 'COMPLETE', department: 'LENOVO', warehouse: '부산', eta: '2025-03-09', createTime: '2025-03-04 11:45', driver: '박기사' },
      { id: 'ORD-004', customer: '기아', type: '배송', status: 'ISSUE', department: 'CS', warehouse: '광주', eta: '2025-03-12', createTime: '2025-03-07 13:20', driver: '최기사' },
      { id: 'ORD-005', customer: 'SK하이닉스', type: '회수', status: 'CANCEL', department: 'HES', warehouse: '김포', eta: '2025-03-08', createTime: '2025-03-03 14:10', driver: '정기사' },
      { id: 'ORD-006', customer: '네이버', type: '배송', status: 'PENDING', department: 'CS', warehouse: '김포', eta: '2025-03-13', createTime: '2025-03-08 09:30', driver: '강기사' },
      { id: 'ORD-007', customer: '카카오', type: '배송', status: 'IN_PROGRESS', department: 'HES', warehouse: '인천', eta: '2025-03-14', createTime: '2025-03-09 10:45', driver: '고기사' },
      { id: 'ORD-008', customer: '쿠팡', type: '회수', status: 'PENDING', department: 'LENOVO', warehouse: '부산', eta: '2025-03-15', createTime: '2025-03-10 11:55', driver: '배기사' },
      { id: 'ORD-009', customer: '배달의민족', type: '배송', status: 'IN_PROGRESS', department: 'CS', warehouse: '광주', eta: '2025-03-16', createTime: '2025-03-11 13:05', driver: '임기사' },
      { id: 'ORD-010', customer: '당근마켓', type: '회수', status: 'COMPLETE', department: 'HES', warehouse: '김포', eta: '2025-03-17', createTime: '2025-03-12 14:20', driver: '한기사' },
      { id: 'ORD-011', customer: '토스', type: '배송', status: 'PENDING', department: 'LENOVO', warehouse: '인천', eta: '2025-03-18', createTime: '2025-03-13 15:30', driver: '곽기사' },
      { id: 'ORD-012', customer: '라인', type: '회수', status: 'ISSUE', department: 'CS', warehouse: '부산', eta: '2025-03-19', createTime: '2025-03-14 16:45', driver: '조기사' }
    ]
  };

  // 차트 객체 저장 변수
  let charts = {
    timeChart: null,
    csChart: null,
    hesChart: null,
    lenovoChart: null,
    allDeptChart: null
  };

  // 날짜 포맷 함수
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  // 날짜 문자열 비교 함수
  function isDateInRange(dateStr, startDateStr, endDateStr) {
    const datePart = dateStr.split(' ')[0]; // 날짜 부분만 추출 (시간 제외)
    const date = new Date(datePart);
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    
    // 날짜 범위에 시간을 포함시키기 위해 종료일의 시간을 23:59:59로 설정
    endDate.setHours(23, 59, 59, 999);
    
    return date >= startDate && date <= endDate;
  }
  
  // 기본 날짜 설정
  function setDefaultDates() {
    const today = new Date();
    const endDate = formatDate(today);
    
    const startDate = new Date();
    startDate.setDate(today.getDate() - 30);
    const startDateStr = formatDate(startDate);
    
    document.getElementById('vizStartDate').value = startDateStr;
    document.getElementById('vizEndDate').value = endDate;
    
    const rangeLabel = document.getElementById('vizDateRangeLabel');
    if (rangeLabel) {
      rangeLabel.textContent = `(${startDateStr} ~ ${endDate})`;
    }
    
    return { startDate: startDateStr, endDate };
  }
  
  // 유형에 따른 날짜 기준 컬럼 설정
  function updateDateColumnIndicator() {
    const chartType = document.getElementById('vizChartType').value;
    const indicator = document.getElementById('dateColumnIndicator');
    
    if (chartType === 'time') {
      indicator.textContent = '기준: create_time';
    } else {
      indicator.textContent = '기준: ETA';
    }
  }
  
  // 시간대별 주문 접수 데이터 준비
  function prepareTimeData(startDate, endDate, department = '') {
    // create_time 기준으로 날짜 필터링
    let filteredOrders = DB.orders.filter(order => 
      isDateInRange(order.createTime, startDate, endDate)
    );
    
    // 부서 필터 적용
    if (department) {
      filteredOrders = filteredOrders.filter(order => order.department === department);
    }
    
    // 시간대별 그룹화
    const timeGroups = {};
    
    // 미리 정의된 시간대
    const timeSlots = [
      '09:00-10:00', '10:00-11:00', '11:00-12:00',
      '12:00-13:00', '13:00-14:00', '14:00-15:00',
      '15:00-16:00', '16:00-17:00', '17:00-18:00'
    ];
    
    // 시간대별 기본값 설정
    timeSlots.forEach(slot => {
      timeGroups[slot] = 0;
    });
    
    // 각 주문의 생성 시간을 시간대로 분류
    filteredOrders.forEach(order => {
      const timeStr = order.createTime.split(' ')[1]; // 시간 부분만 추출
      const hour = parseInt(timeStr.split(':')[0]);
      
      // 시간대 결정
      const timeSlot = `${hour.toString().padStart(2, '0')}:00-${(hour+1).toString().padStart(2, '0')}:00`;
      
      // 해당 시간대가 정의되어 있으면 카운트 증가
      if (timeGroups[timeSlot] !== undefined) {
        timeGroups[timeSlot]++;
      }
    });
    
    // 차트 데이터 형식으로 변환
    return timeSlots.map(slot => ({
      time: slot,
      count: timeGroups[slot]
    }));
  }
  
  // 부서별 상태 분포 데이터 준비
  function prepareDeptStatusData(startDate, endDate, department = '') {
    // ETA 기준으로 날짜 필터링
    let filteredOrders = DB.orders.filter(order => 
      isDateInRange(order.eta, startDate, endDate)
    );
    
    // 전체 부서 상태 분포
    const statusCounts = {
      'CS': { 'PENDING': 0, 'IN_PROGRESS': 0, 'COMPLETE': 0, 'ISSUE': 0, 'CANCEL': 0 },
      'HES': { 'PENDING': 0, 'IN_PROGRESS': 0, 'COMPLETE': 0, 'ISSUE': 0, 'CANCEL': 0 },
      'LENOVO': { 'PENDING': 0, 'IN_PROGRESS': 0, 'COMPLETE': 0, 'ISSUE': 0, 'CANCEL': 0 }
    };
    
    // 각 주문의 부서 및 상태별 카운트
    filteredOrders.forEach(order => {
      if (statusCounts[order.department] && statusCounts[order.department][order.status] !== undefined) {
        statusCounts[order.department][order.status]++;
      }
    });
    
    // 부서별 데이터 준비
    const deptData = {};
    
    // 특정 부서 필터링이 있으면 해당 부서만, 아니면 전체 부서
    const departments = department ? [department] : ['CS', 'HES', 'LENOVO'];
    
    departments.forEach(dept => {
      deptData[dept] = {
        labels: ['대기', '진행', '완료', '이슈', '취소'],
        data: [
          statusCounts[dept]['PENDING'],
          statusCounts[dept]['IN_PROGRESS'],
          statusCounts[dept]['COMPLETE'],
          statusCounts[dept]['ISSUE'],
          statusCounts[dept]['CANCEL']
        ]
      };
    });
    
    // 전체 부서 비교 데이터
    const compareData = {
      labels: ['대기', '진행', '완료', '이슈', '취소'],
      datasets: departments.map(dept => ({
        label: dept,
        data: deptData[dept].data
      }))
    };
    
    return { deptData, compareData };
  }
  
  // 시간대별 주문 차트 생성
  function createTimeChart(data) {
    // 시간대별 차트
    const timeChartCanvas = document.getElementById('orderTimeChart');
    if (timeChartCanvas && typeof Chart !== 'undefined') {
      // 기존 차트가 있다면 파괴
      if (charts.timeChart) {
        charts.timeChart.destroy();
      }
      
      charts.timeChart = new Chart(timeChartCanvas, {
        type: 'bar',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '주문 건수',
            data: data.map(item => item.count),
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '시간대별 배송 건수 (Create Time 기준)'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '주문 건수'
              }
            }
          }
        }
      });
    }
  }
  
  // 부서별 상태 분포 차트 생성
  function createDepartmentCharts(data) {
    const { deptData, compareData } = data;
    
    // 배경색 및 테두리색 설정
    const backgroundColors = [
      'rgba(128, 128, 128, 0.6)',
      'rgba(255, 173, 20, 0.6)',
      'rgba(82, 196, 26, 0.6)',
      'rgba(245, 34, 45, 0.6)',
      'rgba(89, 89, 89, 0.6)'
    ];
    
    const borderColors = [
      'rgb(128, 128, 128)',
      'rgb(255, 173, 20)',
      'rgb(82, 196, 26)',
      'rgb(245, 34, 45)',
      'rgb(89, 89, 89)'
    ];
    
    // CS 부서 차트
    if (deptData.CS) {
      const csChartCanvas = document.getElementById('csChart');
      if (csChartCanvas && typeof Chart !== 'undefined') {
        // 기존 차트가 있다면 파괴
        if (charts.csChart) {
          charts.csChart.destroy();
        }
        
        charts.csChart = new Chart(csChartCanvas, {
          type: 'pie',
          data: {
            labels: deptData.CS.labels,
            datasets: [{
              data: deptData.CS.data,
              backgroundColor: backgroundColors,
              borderColor: borderColors,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }
    
    // HES 부서 차트
    if (deptData.HES) {
      const hesChartCanvas = document.getElementById('hesChart');
      if (hesChartCanvas && typeof Chart !== 'undefined') {
        // 기존 차트가 있다면 파괴
        if (charts.hesChart) {
          charts.hesChart.destroy();
        }
        
        charts.hesChart = new Chart(hesChartCanvas, {
          type: 'pie',
          data: {
            labels: deptData.HES.labels,
            datasets: [{
              data: deptData.HES.data,
              backgroundColor: backgroundColors,
              borderColor: borderColors,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }
    
    // LENOVO 부서 차트
    if (deptData.LENOVO) {
      const lenovoChartCanvas = document.getElementById('lenovoChart');
      if (lenovoChartCanvas && typeof Chart !== 'undefined') {
        // 기존 차트가 있다면 파괴
        if (charts.lenovoChart) {
          charts.lenovoChart.destroy();
        }
        
        charts.lenovoChart = new Chart(lenovoChartCanvas, {
          type: 'pie',
          data: {
            labels: deptData.LENOVO.labels,
            datasets: [{
              data: deptData.LENOVO.data,
              backgroundColor: backgroundColors,
              borderColor: borderColors,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }
    
    // 전체 부서 비교 차트
    const allDeptChartCanvas = document.getElementById('allDeptChart');
    if (allDeptChartCanvas && typeof Chart !== 'undefined') {
      // 기존 차트가 있다면 파괴
      if (charts.allDeptChart) {
        charts.allDeptChart.destroy();
      }
      
      // 데이터셋 색상 설정
      compareData.datasets[0].backgroundColor = 'rgba(24, 144, 255, 0.6)';  // CS
      compareData.datasets[0].borderColor = 'rgba(24, 144, 255, 1)';
      
      if (compareData.datasets.length > 1) {
        compareData.datasets[1].backgroundColor = 'rgba(114, 46, 209, 0.6)';  // HES
        compareData.datasets[1].borderColor = 'rgba(114, 46, 209, 1)';
      }
      
      if (compareData.datasets.length > 2) {
        compareData.datasets[2].backgroundColor = 'rgba(250, 140, 22, 0.6)';  // LENOVO
        compareData.datasets[2].borderColor = 'rgba(250, 140, 22, 1)';
      }
      
      charts.allDeptChart = new Chart(allDeptChartCanvas, {
        type: 'bar',
        data: compareData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '부서별 배송 상태 분포 (ETA 기준)'
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '주문 건수'
              }
            }
          }
        }
      });
    }
  }
  
  // 차트 타입에 따른 표시 전환
  function toggleChartType() {
    const chartType = document.getElementById('vizChartType').value;
    const mainChart = document.getElementById('mainChartContainer');
    const deptCharts = document.getElementById('departmentChartsContainer');
    
    // 날짜 기준 지표 업데이트
    updateDateColumnIndicator();
    
    if (chartType === 'time') {
      mainChart.style.display = 'block';
      deptCharts.style.display = 'none';
    } else {
      mainChart.style.display = 'none';
      deptCharts.style.display = 'block';
    }
  }
  
  // 시각화 데이터 로드 및 차트 생성
  function loadVisualizationData() {
    const startDate = document.getElementById('vizStartDate').value;
    const endDate = document.getElementById('vizEndDate').value;
    const chartType = document.getElementById('vizChartType').value;
    const department = document.getElementById('vizDepartmentFilter').value;
    
    if (!startDate || !endDate) {
      messageUtils.warning('시작일과 종료일을 모두 입력해주세요.');
      return;
    }
    
    loadingUtils.show();
    
    // 기준 컬럼 (차트 타입에 따라 다름)
    const dateColumn = chartType === 'time' ? 'create_time' : 'eta';
    
    setTimeout(() => {
      if (chartType === 'time') {
        // 시간대별 주문 접수 데이터 및 차트 생성
        const timeData = prepareTimeData(startDate, endDate, department);
        createTimeChart(timeData);
      } else {
        // 부서별 상태 분포 데이터 및 차트 생성
        const deptStatusData = prepareDeptStatusData(startDate, endDate, department);
        createDepartmentCharts(deptStatusData);
      }
      
      toggleChartType();
      loadingUtils.hide();
      
      messageUtils.success(`${dateColumn} 기준 (${startDate} ~ ${endDate}) 데이터로 시각화되었습니다.`);
    }, 700);
  }
  
  // 페이지 초기화
  document.addEventListener('DOMContentLoaded', function() {
    // 기본 날짜 설정
    const { startDate, endDate } = setDefaultDates();
    
    // 유형별 날짜 기준 표시 초기화
    updateDateColumnIndicator();
    
    // 초기 데이터 로드 및 차트 생성
    loadVisualizationData();
    
    // 로그아웃 버튼 이벤트
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() {
        if (confirm('로그아웃 하시겠습니까?')) {
          messageUtils.info('로그아웃되었습니다.');
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        }
      });
    }
    
    // 새로고침 버튼 이벤트
    const refreshBtn = document.getElementById('refreshVisualizationBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        loadVisualizationData();
      });
    }
    
    // 시각화 타입 변경 이벤트
    const chartTypeSelect = document.getElementById('vizChartType');
    if (chartTypeSelect) {
      chartTypeSelect.addEventListener('change', function() {
        updateDateColumnIndicator();
        toggleChartType();
      });
    }
    
    // 필터 적용 버튼 이벤트
    const applyFilterBtn = document.getElementById('applyVizFilterBtn');
    if (applyFilterBtn) {
      applyFilterBtn.addEventListener('click', function() {
        loadVisualizationData();
      });
    }
    
    // 날짜 변경 시 범위 레이블 업데이트
    const startDateInput = document.getElementById('vizStartDate');
    const endDateInput = document.getElementById('vizEndDate');
    
    function updateDateRangeLabel() {
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      
      if (startDate && endDate) {
        const rangeLabel = document.getElementById('vizDateRangeLabel');
        if (rangeLabel) {
          rangeLabel.textContent = `(${startDate} ~ ${endDate})`;
        }
      }
    }
    
    if (startDateInput) {
      startDateInput.addEventListener('change', updateDateRangeLabel);
    }
    
    if (endDateInput) {
      endDateInput.addEventListener('change', updateDateRangeLabel);
    }
  });
  </script>
</body>
</html>
