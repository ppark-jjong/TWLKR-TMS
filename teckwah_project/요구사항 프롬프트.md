# 대시보드 (Dashboard) 기능 상세 명세

## 1. API 목록
- GET /dashboard/list (대시보드 목록 조회 – 요청 시 선택한 날짜에 해당하는 ETA 데이터 리스트를 반환하며, 데이터가 없으면 '데이터 없음'으로 표시)
- POST /dashboard (대시보드 생성)
- GET /dashboard/{dashboard_id} (상세 정보 조회)
- PATCH /dashboard/{dashboard_id}/status (상태 변경)
- PATCH /dashboard/{dashboard_id}/remark (메모 수정)
- POST /dashboard/assign (배차 처리 – **선택된 하나 이상의 dashboard_id를 리스트로 전달하여 처리**)
- ~~GET /dashboard/date-range (조회 가능 날짜 범위)~~ *(삭제됨)*

## 2. Frontend UI/UX 상세

### 메인 레이아웃
- 좌측 사이드바 고정, 우측 콘텐츠 영역 스크롤
- 상단 영역 고정 (검색/필터/버튼)
- 테이블 영역 스크롤 (calc(100vh - 상단높이))

### 상단 컨트롤 영역
1. 왼쪽 그룹
- **DatePicker 기반 하루 단위 ETA가 일치하는 목록 조회로 변경됨**  
- DatePicker: 사이즈 large, 너비 280px  
- 날짜 범위 텍스트: secondary 색상, Body-Medium 폰트  
※ 목록 조회 API(GET /dashboard/list)는 선택한 날짜를 기준으로 해당 날짜의 ETA 데이터를 반환하며, 데이터가 없으면 '데이터 없음'으로 표시됨

2. 오른쪽 그룹 (Space 컴포넌트, gap 16px)
- 생성 버튼: type="primary", PlusOutlined 아이콘
- 배차 버튼: default type, CarOutlined 아이콘
- 새로고침 버튼: ghost type, ReloadOutlined 아이콘

### 테이블 구성
- **대시보드와 관리자 페이지 모두 동일한 dashboardTable을 사용함**  
- 체크박스 컬럼: width 60px  
- 종류: width 80px, 중앙 정렬, 색상 구분  
- 부서: width 80px, 중앙 정렬  
- 출발 허브: width 100px, 중앙 정렬  
- 배송 담당: width 100px, 중앙 정렬  
- 주문번호: width 130px, 중앙 정렬  
- 상태: width 100px, Tag 컴포넌트 사용  
- ETA: width 150px, 중앙 정렬  
- 도착 지역: width 130px, Tooltip 사용  
- 행 스타일: 상태별 배경색, hover 효과  
- 페이지네이션: 하단 고정, 50행/페이지

### 상태 변경 조건 (추가됨)
- **상태 변경 시 아래 조건 검증을 반드시 수행함 (단, 요청자의 role이 admin인 경우 조건 검증을 무시할 수 있음)**
  - WAITING → IN_PROGRESS: depart_time을 현재 시간으로 업데이트  
  - IN_PROGRESS → COMPLETE/ISSUE: complete_time을 현재 시간으로 업데이트  
  - CANCEL 또는 WAITING으로 변경 시: 모든 시간 필드를 NULL 처리  
  - 일반 사용자는 변경 가능 상태 목록 검증, 배차 정보 존재 여부 확인, 권한 레벨 확인 등의 조건을 준수해야 함  
  - **단, admin의 경우 조건을 무시할 수 있으나 프론트엔드에서는 '정말 변경하시겠습니까?' 알림창을 반드시 표시하여, 상태 변경 시 적용되는 시간 값(depart_time, complete_time 등)을 신중히 확인하도록 함**

## 3. Backend 서비스 동작

### DashboardService 주요 기능
1. 목록 조회 처리
- ETA 인덱스 활용 쿼리 최적화  
- 데이터 정렬: ETA 컬럼 기준 ASC  
- **DatePicker 기반 하루 단위 ETA 필터링 로직 적용**  
- 선택한 날짜에 해당하는 데이터가 없으면 클라이언트에 '데이터 없음'으로 처리

2. 상태 관리 로직
- 상태 변경 시 시간 자동 업데이트  
- **상태 변경 조건 검증 로직 적용 (일반 사용자의 경우) – 단, 요청자의 role이 admin이면 조건 검증을 무시함**  
- 변경 시 depart_time, complete_time 등 시간 값이 업데이트되므로, 해당 시간 값은 이후 데이터 처리에 중요한 영향을 미침

3. 배차 처리 로직
- 대상 건들의 상태 일괄 검증 (WAITING)  
- **선택된 하나 이상의 dashboard_id 리스트를 받아 벌크 업데이트 처리**  
- 트랜잭션 관리

4. 우편번호 처리 및 대시보드 생성 시 주의 사항
- 우편번호는 5자리 숫자 형식이지만, 데이터 처리 시 **문자열(string)로 관리됨** (앞에 0 포함 가능)
- 백엔드 로직에서 우편번호 처리 및 관련 연산 수행  
- postal_code 테이블 조인 및 트리거를 통한 자동 정보 업데이트  
  - 도시/지역 정보  
  - 거리 계산  
  - 예상 소요 시간

5. 데이터 검증
- 필수 필드 존재 여부  
- 데이터 타입 검증  
- 비즈니스 규칙 검증:  
  - ETA는 현재 시점 이후여야 함  
  - 연락처 형식 확인  
  - 우편번호 존재 여부

## 4. 프론트엔드/백엔드/DB 레이어 구분
- **프론트엔드:** UI 구성, API 호출, 상태 관리  
- **백엔드:** 요청 검증, 비즈니스 로직 처리, 데이터 가공  
- **데이터베이스:** 인덱스 최적화, 트랜잭션 관리, 데이터 정합성 유지

-------------------------------------------------------------------------------

# 관리자 페이지 (AdminPage) 기능 상세 명세

※ **관리자 페이지는 user.role이 'ADMIN'인 경우에만 접근 가능함**

## 1. API 목록
- DELETE /dashboard (선택 항목 삭제 – **선택된 하나 이상의 dashboard_id 리스트를 받아 벌크 삭제 처리**)  
- 기타 API는 Dashboard와 공유 (목록 조회는 GET /dashboard/list를 사용하며, 선택한 날짜의 ETA 데이터를 반환함)

## 2. Frontend UI/UX 상세

### 메인 레이아웃 (DashboardPage와 차이점)
- **기간 선택 기능은 삭제되고, DatePicker를 기반으로 하루 단위 ETA 조회로 변경됨**  
- 삭제 버튼 추가 (DeleteOutlined 아이콘)

### 기간 선택 영역
- **기존 RangePicker 대신 DatePicker 사용**  
- DatePicker: 사이즈 large, 너비 280px  
- 기본 선택: 특정 하루의 ETA 기준 조회

### 테이블 기능
- **Dashboard와 동일한 dashboardTable을 사용함**  
- 관리자 페이지에서는 상태 변경 조건에 제한이 없으며(단, 프론트엔드에서 확인 알림창 표시), 삭제 기능이 추가됨  
- 삭제 버튼: danger type, 선택된 행 있을 때 활성화

### 상세 정보 모달
- DashboardPage와 동일한 구조  
- 상태 변경 시 제한 없음 (is_admin: true)  
- 단, 상태 변경 시 추가 확인 모달(“정말 변경하시겠습니까?”)을 표시하여, 상태 변경 시 적용되는 시간 값에 주의하도록 함

## 3. Backend 서비스 동작

### AdminDashboardService 특화 기능
1. 권한 검증
- **관리자 페이지 접근은 user.role이 'ADMIN'인 경우에만 허용됨**  
- user_role === 'ADMIN' 확인  
- 권한 없을 시 403 Forbidden 응답

2. ETA 기준 조회 처리
- 특정 날짜(ETA) 기준 전체 데이터 조회  
- 상태 무관 조회  
- 페이지네이션은 프론트엔드에서 처리하며, 선택한 날짜에 해당하는 데이터가 없으면 '데이터 없음'으로 표시됨

3. 삭제 처리
- **선택된 하나 이상의 dashboard_id 리스트를 받아 벌크 삭제 처리**  
- 상태 제한 없이 삭제  
- 트랜잭션 관리

-------------------------------------------------------------------------------

# 시각화 (Visualization) 기능 상세 명세

## 1. API 목록
- GET /visualization/delivery_status (배송 현황 데이터)
- GET /visualization/hourly_orders (시간대별 접수량)

## 2. Frontend UI/UX 상세

### 차트 선택 영역
1. 상단 컨트롤
- 차트 타입 Select: 너비 200px, large  
- **RangePicker: 너비 320px, large**  
  - **선택 가능한 날짜는 create_time을 기준으로 분석 가능한 날짜로 제한되어, 데이터가 없는 날짜는 선택할 수 없도록 제어함**  
  - 만약 선택된 날짜에 해당하는 데이터가 없으면 '데이터 없음' 메시지를 표시함

2. 차트 타입 옵션
- 배송 현황: PieChartOutlined 아이콘  
- 시간대별 접수량: BarChartOutlined 아이콘

### 배송 현황 차트
1. 레이아웃
- 3개의 도넛 차트 (Row-Col 구조)  
- 각 차트 너비 33.33%  
- Card 컴포넌트로 래핑

2. 차트 스타일
- 도넛 차트 내부: 부서명과 총계  
- 외부 레이블: 상태명과 비율  
- 부서별 컬러 테마:  
  - CS: 파란색 계열  
  - HES: 보라색 계열  
  - LENOVO: 청록색 계열

3. 분석 기준
- **배송 현황 데이터는 RangePicker로 선택된 날짜 기간에 해당하는 create_date 컬럼의 데이터를 기반으로 분석됨**

### 시간대별 접수량 차트
1. 레이아웃
- 상단 통계 카드 3개 (부서별)  
- 하단 막대 그래프

2. 차트 구성
- X축: 시간대 (08-22시 1시간 단위, 22-08시 통합)  
- Y축: 접수 건수  
- 그룹화: 부서별 3개 막대  
- 평균선 표시

3. 통계 카드
- 총 접수량  
- 주간/야간 비율  
- 시간당 평균

4. 분석 기준
- **시간대별 접수량 데이터 역시 RangePicker로 선택된 날짜 기간에 해당하는 create_date 컬럼의 데이터를 기반으로 분석됨**

## 3. Backend 서비스 동작

### VisualizationService 주요 기능
1. 데이터 분석 (pandas 활용)
- 부서별/상태별 집계  
- 시간대별 그룹핑  
- 평균, 비율 계산

2. 시간대 처리
- 주간(08-22시): 1시간 단위 집계  
- 야간(22-08시): 통합 집계  
- UTC/KST 변환 처리

3. 최적화
- 집계 쿼리 최적화  
- 데이터 캐싱 고려  
- 대량 데이터 처리 방안

-------------------------------------------------------------------------------

# 공통 기능 상세 명세

## 1. 인증/인가 처리

### Frontend 공통 처리
1. 토큰 관리
- localStorage 저장 항목:  
  - access_token  
  - refresh_token  
  - user (JSON 형태로 저장)
- 토큰 갱신 로직:  
  - 401 응답 시 자동 갱신  
  - 갱신 실패 시 로그인 페이지 이동  
  - 중복 갱신 요청 방지

2. 권한 기반 라우팅
- AuthProvider 컴포넌트:  
  - 전역 사용자 정보 관리  
  - 인증 상태 관리
- PrivateRoute 컴포넌트:  
  - 비로그인 시 리다이렉트  
  - returnUrl 저장

3. 레이아웃 처리
- 인증 필요 페이지:  
  - MainLayout 적용  
  - 사이드바 포함
- 인증 불필요 페이지:  
  - 단순 레이아웃  
  - 중앙 정렬 디자인

### Backend 공통 처리 
1. JWT 검증
- 토큰 구조:  
  - access_token (60분)  
  - refresh_token (7일)  
  - 페이로드: user_id, department, role
- 검증 내용:  
  - 서명 검증  
  - 만료 시간 확인  
  - 토큰 형식 확인

2. 권한 검증 미들웨어
- API 엔드포인트 보호  
- 역할 기반 접근 제어:  
  - ADMIN 전용 엔드포인트  
  - 부서별 접근 제한

## 2. 에러 처리

### Frontend 에러 처리
1. API 에러 인터셉터
- 공통 에러 처리:  
  - 네트워크 에러  
  - 서버 에러  
  - 인증 에러
- 사용자 피드백:  
  - antd message 컴포넌트 사용  
  - 적절한 에러 메시지 표시

2. 컴포넌트 에러 바운더리
- ErrorBoundary 컴포넌트:  
  - React 렌더링 에러 캐치  
  - 폴백 UI 제공
- 에러 로깅:  
  - 콘솔 로깅  
  - 필요시 에러 트래킹 서비스 연동

### Backend 에러 처리
1. 예외 처리
- HTTP 예외:  
  - 400: 잘못된 요청  
  - 401: 인증 실패  
  - 403: 권한 없음  
  - 404: 리소스 없음  
  - 500: 서버 에러

2. 커스텀 예외 클래스
- 비즈니스 로직 예외:  
  - DashboardError  
  - AuthenticationError  
  - ValidationError
- 상세 에러 메시지:  
  - 한글 에러 메시지  
  - 디버깅 정보 포함

## 3. 메시지 처리

### Frontend 메시지
1. 성공 메시지
- 생성/수정/삭제 완료  
- 배차 완료  
- 상태 변경 완료  
- 데이터 조회 완료

2. 경고 메시지
- 날짜 범위 초과  
- 선택 항목 없음  
- 필수 입력 누락

3. 에러 메시지
- API 호출 실패  
- 권한 없음  
- 유효성 검증 실패

### Backend 메시지
1. 응답 메시지
- 성공 응답:  
  - 구체적인 성공 메시지  
  - 처리된 데이터 정보
- 실패 응답:  
  - 구체적인 실패 사유  
  - 해결 방안 제시

2. 로그 메시지
- 정보 로그:  
  - API 호출 정보  
  - 데이터 처리 정보
- 에러 로그:  
  - 스택 트레이스  
  - 컨텍스트 정보

-------------------------------------------------------------------------------

# 데이터베이스 연동 및 처리 상세 명세

## 1. 데이터베이스 구조

### 테이블 관계
1. Dashboard 테이블 (메인)
- FK 관계:  
  - postal_code → postal_code 테이블  
  - department → user 테이블의 user_department
- 인덱스:  
  - eta (조회 성능)  
  - create_time (시각화 성능)  
  - status (상태 필터링)  
  - department (부서별 조회)

2. PostalCode 테이블
- 기본 정보:  
  - 우편번호 (PK)  
  - 도시/지역 정보  
  - 거리/시간 정보
- Hub별 정보:  
  - 담당 허브 정보  
  - 거리 계산 기준

3. User/RefreshToken 테이블
- 사용자 정보:  
  - 인증 정보  
  - 부서 정보  
  - 권한 정보
- 토큰 관리:  
  - 리프레시 토큰  
  - 만료 시간

### 트리거 동작
1. trg_dashboard_before_insert_postal
- 실행 시점: INSERT 전
- 처리 내용:  
  - 우편번호 유효성 검증  
  - 허브별 거리/시간 계산  
  - 지역 정보 자동 설정
- 에러 처리:  
  - 잘못된 우편번호  
  - 허브 정보 누락  
  - 계산 실패

## 2. 데이터 접근 최적화

### Repository 레이어
1. 쿼리 최적화
- JOIN 최소화:  
  - 필요한 경우만 INNER JOIN  
  - LEFT JOIN 필요성 검토
- 인덱스 활용:  
  - WHERE 절 조건 최적화  
  - ORDER BY 절 고려
- 집계 쿼리:  
  - 서브쿼리 최소화  
  - 임시 테이블 활용

2. 벌크 연산
- 대량 삭제:  
  - IN 절 활용  
  - 트랜잭션 관리
- 상태 업데이트:  
  - 다중 행 업데이트  
  - 정합성 보장

### 성능 최적화
1. 캐싱 전략
- 조회 데이터:  
  - 자주 사용되는 마스터 데이터  
  - 통계 데이터
- 캐시 갱신:  
  - 데이터 변경 시  
  - 주기적 갱신

2. 커넥션 관리
- 풀링:  
  - 최적 풀 사이즈  
  - 타임아웃 설정
- 트랜잭션:  
  - 적절한 격리 수준  
  - 데드락 방지

## 3. 데이터 정합성

### 트랜잭션 관리
1. 서비스 레이어
- 트랜잭션 범위:  
  - 단일 작업 단위  
  - 롤백 포인트
- 격리 수준:  
  - READ COMMITTED 사용  
  - 필요시 SERIALIZABLE

2. 동시성 제어
- 락 전략:  
  - 낙관적 락  
  - 비관적 락
- 충돌 해결:  
  - 재시도 로직  
  - 충돌 알림

### 데이터 검증
1. 입력 데이터
- 스키마 검증:  
  - Pydantic 모델  
  - 비즈니스 규칙
- 참조 무결성:  
  - FK 제약 조건  
  - Cascade 설정

2. 출력 데이터
- 데이터 정제:  
  - NULL 처리  
  - 형식 통일
- 응답 포맷:  
  - 일관된 구조  
  - 타입 변환
