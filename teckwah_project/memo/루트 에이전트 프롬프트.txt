# 배송 실시간 관제 시스템 프롬프트 (최종 완성본)

아래는 지금까지의 전체 요구사항과 추가 지침을 통합하고,  
**폴더 구조 정보는 제외**한 **최종 문서**입니다.  
(이 문서는 내부 협업/개발 시 **공통 참고 자료**로 사용됩니다.)

---

## 1. 프로젝트 개요 및 배경

### 1.1 목적

- **기업 내부에서 사용할 배송 실시간 관제 및 데이터 시각화 서비스**를 개발한다.
- **실시간 배송 주문 관리 및 모니터링**  
  - ETA(도착 예정 시간) 기준으로 주문을 조회하고 상태를 관리한다.
- **효율적인 배차 관리**  
  - 담당자 배정 및 상태 변경을 통한 배송 과정 최적화.
- **데이터 기반 의사결정 지원**  
  - 직관적인 시각화와 시간대별 주문 데이터 분석 기능 제공.
- **권한별 차별화된 기능 제공**  
  - 일반 사용자와 관리자의 권한 및 기능을 구분하여 제공.
- **동시성 제어**  
  - **비관적 락(Pessimistic Lock)**을 통해 다중 사용자 환경에서 데이터 무결성을 보장한다.

### 1.2 배경

- 본 프로젝트는 **전 풀스택/데이터 엔지니어**가 단독 개발을 시작했고, 곧 **서비스 배포**가 예정되어 있다.
- 모든 **주석은 한국어**로 작성하며, **요청된 기능**만 수정·생성한다.
- 추가 요청이 있으면 **새로운 로직**을 구현하되, 기존 구조는 최대한 유지한다.

### 1.3 특징

- **상세한 설명 및 한국어 주석** 제공.
- **비관적 락**으로 동시성 제어(낙관적 락은 오버엔지니어링으로 판단, 배제).
- **DB 모델(테이블 구조) 변경은 사전 허가** 후 진행 가능.
- **무료 라이브러리만** 사용(유료 라이선스 라이브러리 사용 불가).

### 1.4 배송 데이터 흐름

1. **주문 접수**  
   - `order_no`를 생성하고, 초기 상태를 `WAITING`으로 설정  
   - `create_time` 자동 기록
2. **배차 처리**  
   - 기사 정보(`driver_name`, `driver_contact`)를 업데이트
3. **상태 변경**  
   - `WAITING` → `IN_PROGRESS` → `COMPLETE` / `ISSUE` / `CANCEL`
4. **시간 기록**  
   - 접수 시간: `create_time`  
   - 진행 시작: `depart_time` (상태가 `IN_PROGRESS`로 변할 때 기록)  
   - 완료/이슈: `complete_time` (`COMPLETE`/`ISSUE` 상태일 때 기록)
5. **동시 접속 비관적락**
   - 모든 동시 수정들의 접근 프로세스는 비관적락으로 막고 유저 알림처리
---

## 2. 기술 스택 및 아키텍처

### 2.1 프론트엔드

- **주요 기술**  
  - Dash (Python 기반)
  - Dash Core Components, Dash HTML Components
  - Dash Bootstrap Components (Ant Design 대체)
  - Callback을 통한 동적 UI 구성 및 상태 관리
  - Python `requests` 모듈을 통한 내부 REST API 통신 (FastAPI)
- **코드 스타일**  
  - 주석과 디버깅 메시지는 모두 한국어 사용
  - 가독성과 간결성 중시, DRY 원칙 준수

- **빌드/설정**  
  - Dash 기본 빌드 방식 유지
  - 프론트엔드와 백엔드는 **동일 도메인** 내에서 통신  
  - 무료 라이브러리만 사용

### 2.2 백엔드

- **프레임워크**: FastAPI 0.95.x 이상 (Python)
- **구조**  
  - **API 라우터**: 요청/응답 처리  
  - **서비스 레이어**: 비즈니스 로직 담당  
  - **레포지토리 레이어**: DB 접근 로직 담당  
  - **모델/스키마**:  
    - `models` 디렉토리에 DB 모델  
    - `schemas` 디렉토리에 요청/응답용 스키마  
    - DB 구조 변경 시 사전 허가 필수
- **ORM**: SQLAlchemy 2.0.x
- **인증**: JWT 기반 인증
- **API 호출 흐름**  
  - 클라이언트 → API 라우터(엔드포인트) → 서비스 레이어 → 레포지토리 → DB  
  - 응답은 역순으로 전달

### 2.3 데이터베이스

- **핫 데이터**: MySQL 8.0 (최근 1개월치 데이터 유지, ETA 컬럼 인덱스 적용)  
  - 로컬 환경: Docker-compose로 MySQL 컨테이너 실행 (host: `mysql`, port: 3306, DB명: `delivery_system`, 계정: `root/1234`)
- **콜드 데이터**: BigQuery (장기 보관)

### 2.4 배포 및 테스트 환경

- **배포 환경**: Google App Engine (GAE)  
  - 단일 컨테이너 방식, HTTPS/SSL 자동 적용
  - **supervisord**를 사용하여 Dash와 FastAPI 프로세스를 동시에 관리
    - 두 애플리케이션이 하나의 컨테이너 내에서 독립적으로 실행
    - supervisord를 통한 프로세스 자동 재시작 및 상태 모니터링 기능 활용
    - 로깅 및 에러 출력 관리를 supervisord 설정으로 통합 제어

- **로컬 테스트**: Docker-desktop 사용  
  - 운영 환경과 유사한 단일 컨테이너 구성 (supervisord 사용 권장)
  - Dash 및 FastAPI 프로세스를 supervisord로 동일 컨테이너 내에서 동시에 구동하여 내부 REST API 통신 테스트 수행



## 3. 개발 및 배포 가이드라인

### 3.1 개발 원칙

- **모듈화 및 관심사 분리**: API 라우터, 서비스, 레포지토리, 모델/스키마를 구분
- **주석 및 디버깅 메시지**: 전부 한국어 사용
- **일관성 유지**: 코드 스타일(네이밍, 디렉토리 구조, API 응답 규격 등)
- **DB 모델 변경 제한**: 구조 변경 시 사전에 논의 필요
- **무료 라이브러리만** 사용 가능

### 3.2 구축/테스트

- **로컬 환경**  
  - Docker-desktop으로 **단일 컨테이너** 구성  
  - MySQL 컨테이너와 동일 네트워크  
  - `init-db.sql` 등으로 DB 초기 스키마 생성
- **운영/배포**  
  - Google App Engine(GAE) 배포(HTTPS/SSL 자동)  
  - `.env.local`을 `.env.production`으로 변환 후 사용  
  - 단일 컨테이너 이미지 빌드 → GAE 업로드

### 3.3 예외/에러 처리

- **423 Locked**로 비관적 락 충돌 처리
- **HTTP 상태 코드** 준수 (400, 401, 403, 404, 500 등)
- **에러 메시지**는 한국어로 응답·로그

### 3.4 추가 지침 및 룰

- **동일 도메인 서빙**  
  - 프론트엔드와 백엔드는 동일 도메인에서 상호 호출
- **코드 생성 원칙**  
  - 요청된 내용만 정확히 수정·생성  
  - 추가 요청 시 새 로직 작성 (기존 구조 최대한 유지)
- **문서화**  
  - 프로젝트 내 주석, 로그, 디버깅 메시지는 모두 한국어  

---

## 7. 예상 용량 및 사용량

### 7.1 Cloud SQL (MySQL) 저장 용량

- **일평균 50건 주문 + 50건 리마크** → 하루 100행, 연간 36,500행
- 인덱스와 로그 등을 포함해 **1.5배** 여유로 고려하면,  
  - **연간 약 150MB** 수준 (1개월치만 저장 후 BigQuery로 이전)

### 7.2 Cloud SQL (MySQL) 처리량 (TPS)

- **쓰기(Insert)**  
  - 하루 50~100건 → TPS 부담 미미
- **읽기(Query)**  
  - 초당 약 10회(QPS 10), 동시 사용자 50명 미만  
  - 일반적인 중소형 MySQL 인스턴스로 충분 처리 가능

### 7.3 예상 사용량
- **유저 사용량**
	- 일평균 100건 생성, TPS 100 이하, 동시 사용자 50명 미만
---

## 마무리

위 내용은 **프로젝트 전반**(기능 요구사항, 비관적 락 적용, QA 시나리오, 예상 용량 등)을 망라한 **최종 루트 프롬프트**입니다.  
개발·운영 시, 다음 사항을 반드시 준수해 주십시오.

1. **비관적 락**으로 다중 사용자 환경에서의 **데이터 무결성** 유지  
2. **DB 구조 변경은 사전 협의**  
3. **한국어 주석** 및 로그/에러 메시지  
4. **무료 라이브러리만** 활용  
5. **동일 도메인** 내에서 프론트·백엔드 연동

*(위 문서는 txt 형식이며, 필요 시 내부 위키나 협업 툴에 복사·활용하시기 바랍니다.)*
